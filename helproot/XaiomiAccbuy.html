<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bootloader Unlock Permission Account Buy Online</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
/* [ALL YOUR EXISTING STYLES REMAIN SAME - NO CHANGES NEEDED] */
* {box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html, body {height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#0f1220; color:#eaeaf0; overflow-x:hidden;}
body {padding-bottom: env(safe-area-inset-bottom);}
  
/* Dashboard card ko position relative dena zaroori hai */
#dashboard {
  position: relative;
}

.support-btn {
  position: absolute; /* Fixed ki jagah absolute */
  top: 15px; 
  right: 15px;
  width: 40px;
  height: 40px;
  background: #25D366; 
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
  z-index: 10;
  border: 2px solid #fff;
  text-decoration: none;
}

.support-btn img {
  width: 28px;
    height: 28px;
}

/* Mobile par agar dashboard chota hai toh adjustment */
@media (max-width: 768px) {
  .support-btn {
   top: 30px;
    right: 15px;
    width: 45px;
    height: 45px;
  }
}

.social-links {
  border-top: 1px solid rgba(255,255,255,0.1);
  margin-top: 15px;
  padding-top: 5px;
}

.social-icon {
  width: 45px;
  height: 45px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  background: rgba(255,255,255,0.05);
}

.social-icon img {
  width: 25px;
  height: 25px;
}

/* Hover Effects */
.social-icon:hover {
  transform: translateY(-3px);
  background: rgba(255,255,255,0.1);
}

.social-icon.tg:hover {
  box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
}

.social-icon.yt:hover {
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}

.app-container {min-height:100vh; display:flex; flex-direction:column;}
#lock {max-width:100%; width:100%; margin:0; border-radius:0; height:90vh; display:flex; flex-direction:column; justify-content:center; padding:20px; background:linear-gradient(135deg, #0f1220 0%, #1a1f3a 100%);}
#lock .card {max-width:100%; width:100%; padding:25px; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.3);}

button {padding:14px 20px; margin:8px 0; border:0; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; min-height:48px; touch-action:manipulation;}
.action {background:#6d7cff; color:#fff;}
.action:hover {background:#5a6de6;}
.danger {background:#ff4444; color:#fff;}
.danger:hover {background:#e63939;}
.admin-only {background:#ff6b35 !important;}
.manual-give {background:#00d4aa !important; color:#000;}
.manual-verify {background:#ffeb3b !important; color:#000;}
.sold-out {background:#ff4444 !important; color:#fff !important;}

#qrModal {position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:1000; display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px;}
#qrModal.show {display:flex;}
.qr-container {background:#1b1f3b; padding:30px; border-radius:24px; text-align:center; box-shadow:0 25px 50px rgba(0,0,0,0.6);}
#qrCode {margin:20px 0; border-radius:16px; background:#fff; padding:10px;}
.qr-close {position:absolute; top:20px; right:20px; background:#ff4444; color:#fff; border:none; border-radius:50%; width:50px; height:50px; font-size:20px; cursor:pointer;}

.broadcast-popup {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg, #ff6b35, #ff8e53); color:#fff; padding:30px; border-radius:24px; max-width:90vw; max-height:80vh; z-index:999; display:none; box-shadow:0 30px 60px rgba(255,107,53,0.4); text-align:center; backdrop-filter:blur(20px);}
.broadcast-popup.show {display:block; animation:popupSlide 0.4s cubic-bezier(0.4,0,0.2,1);}
.broadcast-popup h3 {margin:0 0 15px 0; font-size:24px;}
.broadcast-popup p {font-size:16px; line-height:1.5; margin-bottom:25px;}
.broadcast-close {background:#fff; color:#ff6b35; border:none; padding:12px 30px; border-radius:25px; font-weight:700; font-size:16px; cursor:pointer;}
@keyframes popupSlide {from {opacity:0; transform:translate(-50%,-60%) scale(0.9);} to {opacity:1; transform:translate(-50%,-50%) scale(1);}}

input {padding:16px; margin:10px 0; border-radius:12px; border:1px solid #2a2f4a; background:#1b1f3b; color:#fff; font-size:16px; width:100%;}
input::placeholder {color:#8a8fc4;}
input:focus {outline:none; border-color:#6d7cff; box-shadow:0 0 0 3px rgba(109,124,255,0.2);}

/* --- COMPACT MOBILE NAV CSS --- */
#mobileBottomNav {
  position: fixed; 
  bottom: 0; 
  left: 0; 
  right: 0; 
  background: #15193a; 
  display: flex; 
  z-index: 100; 
  padding: 5px 10px; /* Padding kam ki */
  box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
  height: 60px; /* Fixed height set ki */
  align-items: center;
}

.nav-item {
  flex: 1; 
  text-align: center; 
  padding: 0 4px; /* Side gap kam kiya */
}

.nav-item button {
  width: 100%; 
  font-size: 20px; /* Icon thoda bada */
  padding: 8px 0; /* Button ke andar space kam ki */
  border-radius: 12px; 
  min-height: 40px; /* Height reduce ki */
  background: transparent; /* Default transparent */
}

.nav-active {
  background: #6d7cff !important; 
  color: white;
  box-shadow: 0 4px 10px rgba(109,124,255,0.3);
}


.sidebar {position:fixed; left:-280px; top:0; width:180px; height:100vh; background:#15193a; z-index:200; padding:20px; transition:all 0.3s cubic-bezier(0.4,0,0.2,1); overflow-y:auto; box-shadow:2px 0 15px rgba(0,0,0,0.4);}
.sidebar.open {left:0;}
.sidebar-overlay {
  position:fixed; top:0; left:0; right:0; bottom:0; 
  background:rgba(0,0,0,0.6); z-index:150; 
  display:none; 
  backdrop-filter: blur(3px); /* Thoda blur effect */
}
.sidebar-overlay.show {
  display:block !important; /* Jab active hoga tab dikhega */
}

.sidebar h3 {margin:0 0 25px 0; font-size:20px;}
.sidebar button {width:100%; margin:8px 0; padding:14px; border-radius:12px; text-align:left; font-size:15px; transition:background 0.2s ease;}
.sidebar button:hover {background:#2f36a3;}

.main{ flex:1; padding:14px; padding-bottom:110px; overflow-y:auto; display:flex; flex-direction:column; align-items:center;}
.card{ width:100%; max-width:520px; background:linear-gradient(180deg,#1b1f3b,#141735); border-radius:22px; padding:22px 18px; margin:12px 0; box-shadow:0 15px 45px rgba(0,0,0,.45);}
.card h3{ margin:0 0 18px 0; font-size:20px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:10px; text-align:center;}

.stats-grid{ width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:10px;}
.stat-card{ background:linear-gradient(135deg,#2b3080,#1f245c); padding:18px 10px; border-radius:18px; text-align:center; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);}
.stat-card b{ display:block; font-size:11px; letter-spacing:.5px; opacity:.75; margin-bottom:6px;}
.stat-card span{ font-size:20px; font-weight:700;}
.ok{color:#6dff9a}
.bad{color:#ff7b7b}
.pending{color:#ffeb3b}

.copy-btn {background:#00d4aa !important; color:#000 !important; font-size:14px; padding:8px 16px; margin:2px; border-radius:8px; font-weight:600;}
.copy-btn:hover {background:#00b894 !important;}
.copy-success {background:#6dff9a !important; color:#000 !important; animation:copyPulse 0.3s ease;}

@keyframes copyPulse {0%,100%{transform:scale(1);} 50%{transform:scale(1.05);}}

@media(min-width:768px){
  .stats-grid{ grid-template-columns:repeat(4,1fr);}
  .app-container {flex-direction:row;}
  .sidebar {left:0; width:260px; z-index:1;}
  .sidebar-overlay {display:none !important;}
  #mobileBottomNav {display:none;}
  .main {padding:10px; padding-left:295px; padding-bottom:30px;}
  #menuBtn {display:none;}
  #lock {max-width:500px; margin:50px auto; height:auto;}
  .card {max-width:700px;}
}

@media (max-width: 480px) {
  .main {padding:15px;}
  .card {padding:20px; margin:10px 0;}
  button {padding:16px; font-size:17px;}
  input {padding:18px;}
}

.list .item {background:#23286a; border-radius:16px; padding:20px; margin:15px 0;}
.row {display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;}
.row button {flex:1; min-width:100px;}

.product-creds { background: linear-gradient(135deg, #1a3a1a, #2d5a2d); border: 1px solid #4a9a4a; border-radius: 12px; padding: 15px; margin: 10px 0; }
.product-creds.pending { background: linear-gradient(135deg, #ffeb3b, #ffd54f); border: 1px solid #fbc02d; color: #000; }
.product-creds b { color: #6dff9a; font-size: 16px; }
.product-creds.pending b { color: #000; }
.product-creds .copy-row {display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
.product-creds .copy-row button {flex:1; min-width:80px;}

#notify {position:fixed; top:20px; right:20px; left:20px; max-width:400px; margin:0 auto; background:#6d7cff; color:#fff; padding:16px 20px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.4); display:none; z-index:9999; font-weight:500;}
.hidden {display:none !important;}

body.login-mode #menuBtn, body.login-mode #sidebar, body.login-mode #mobileBottomNav { display: none !important;}

#menuBtn {position:fixed; top:20px; left:20px; z-index:250; background:#6d7cff; border:none; border-radius:12px; width:50px; height:50px; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all 0.25s cubic-bezier(0.4,0,0.2,1);}
#menuBtn.hidden {opacity:0; transform:scale(0.8); pointer-events:none;}

.manual-access-section { background: linear-gradient(135deg, #00d4aa, #00a085); border-radius: 16px; padding: 20px; margin: 15px 0; }
.manual-access-section input { background: rgba(255,255,255,0.95); color: #000; border: 2px solid #00d4aa; }
.manual-access-section button { background: #000 !important; color: #00d4aa !important; font-weight: 700; border: 2px solid #00d4aa; }

.broadcast-section {background: linear-gradient(135deg, #ff6b35, #ff8e53); border-radius:16px; padding:20px; margin:15px 0;}
.broadcast-section textarea {width:100%; height:120px; background:rgba(255,255,255,0.95); color:#000; border-radius:12px; border:2px solid #ff6b35; padding:15px; font-size:16px; resize:vertical;}

.transaction-section {background: linear-gradient(135deg, #ffeb3b, #ffd54f); border-radius:16px; padding:20px; margin:15px 0;}
.transaction-section input { background: rgba(0,0,0,0.9); color: #fff; border: 2px solid #ffeb3b; }
.product-creds.pending { 
  background: linear-gradient(135deg, #444, #222) !important; 
  border: 1px dashed #ffeb3b !important; 
  color: #ffeb3b !important; 
}

</style>
</head>
<body>

<!-- BROADCAST POPUP -->
<div id="broadcastPopup" class="broadcast-popup">
  <h3 id="broadcastTitle">üéâNEW YEAR SPECIAL OFFER!</h3>
  <p id="broadcastMessage">Get 50% OFF on all premium accounts today only!</p>
  <button class="broadcast-close" onclick="closeBroadcast()">Got it! üéÅ</button>
</div>

<!-- QR CODE MODAL -->
<div id="qrModal">
  <button class="qr-close" onclick="closeQRModal()">‚úï</button>

  <div class="qr-container">
    <h3>Manual Payment Required</h3>

    <!-- QR + Download -->
    <div style="position:relative; display:inline-block;">
      <img
        id="qrCodeImg"
        src="https://helproot.github.io/images/qr.png"
        alt="QR Code"
        style="width:220px;height:220px;border-radius:0px;"
      />

      <!-- Download Icon -->
      <a href="https://helproot.github.io/images/qr.png"
         download
         title="Download QR"
         style="
           position:absolute;
           bottom:4px;
           right:2px;
           background:#ffda6a;
           padding:2px;
           border-radius:0%;
           text-decoration:none;
           color:#fff;
           font-size:16px;
         ">
        ‚¨áÔ∏è
      </a>
    </div>

    <!-- UPI + Copy -->
    <p style="font-size:14px;color:#ffda6a; display:flex; align-items:center; justify-content:center; gap:6px;">
      üí≥ UPI ID: 
      <span id="upiId">igrishu2024@okaxis</span>
      <span
        onclick="copyUPI()"
        title="Copy UPI ID"
        style="cursor:pointer;">
        üìã
      </span>
    </p>

    <p>Pay via UPI/GPay and submit transaction ID below:</p>

    <input id="transactionId" placeholder="Enter Transaction ID / UTR">

    <button class="action" onclick="submitTransaction()">
      Submit Payment Proof
    </button>

    <p style="font-size:14px;color:#ffda6a;">
      ‚è≥ Admin will verify within 5m ‚è≥
    </p>
  </div>
</div>
<script>
function copyUPI() {
  const upi = document.getElementById("upiId").innerText;
  navigator.clipboard.writeText(upi);
  alert("UPI ID copied: " + upi);
}

</script>


<button id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
<div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

<div id="app" class="app-container hidden">
  <div id="mobileBottomNav">
    <div class="nav-item"><button class="nav-active" onclick="showSection('dashboard', true)">üìä</button></div>
    <div class="nav-item"><button onclick="showSection('products', true)">üõí</button></div>
    <div class="nav-item"><button onclick="showSection('mykeys', true)">üîë</button></div>
    <div class="nav-item"><button onclick="showQRModal()">üí≥</button></div>
  </div>

  <div class="sidebar" id="sidebar">
    <h3 id="userType">‚ö°Panel</h3>
    <button onclick="showSection('dashboard')">üìäDashboard</button>
    <button onclick="showSection('products')">üõíAccounts</button>
    
    <div id="userSection">
      <button onclick="showSection('mykeys')">üîëMy Purchase</button>
      <button id="payBtn" onclick="showQRModal()">üí≥Get Access</button>
    </div>

    <div id="adminSection" class="hidden">
      <button class="admin-only" onclick="showSection('manageProducts')">üîßManage Acc</button>
      <button class="admin-only" onclick="showSection('manageUsers')">Manage Users</button>
      <button class="admin-only manual-verify" onclick="showSection('verifyTransactions')">Verify‚úÖPayments</button>
      <button class="admin-only" onclick="showSection('addProduct')">Add‚ûïAccount</button>
      <button class="manual-give admin-only" onclick="showSection('manualAccess')">GiftüéÅAccess</button>
      <button class="admin-only" onclick="showSection('broadcast')">üì¢Broadcast</button>
    </div>

    <button onclick="logout()">üö™Logout</button>
  </div>


  <div class="main">
    <!-- DASHBOARD -->
    <div id="dashboard" class="card">
      <h3>üìäDashboardüìä</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <b id="userInfo">Loading...</b>
          <small>User Email</small>
        </div>
        <div class="stat-card">
          <b id="roleBadge" class="ok">Loading...</b>
          <small>Role</small>
        </div>
        <div class="stat-card">
          <b id="totalProducts">0</b>
          <small>Total Account</small>
        </div>
        <div class="stat-card">
          <b id="userKeys">0</b>
          <small>Verified Purchase</small>
            
        </div>
      </div>
      <p style="font-size: 15px; opacity: 0.5; margin: 15px 0 10px 5px; text-align: center;">Buy Xaiomi Community Bootloader Unlock Permission Account.</p>
    </div>
<a href="https://wa.me/918051450233?text=Hlw%Sir%20I%20need%20help
" target="_blank" class="support-btn" title="Contact Support">
  <img src="https://cdn-icons-png.flaticon.com/512/3670/3670051.png" alt="Support">
</a>
<div class="social-links">
  <p style="font-size: 11px; opacity: 0.5; margin: 15px 0 10px 5px; text-align: center;">FOLLOW US</p>
  <div style="display: flex; gap: 10px; padding-left: 5px;">
    <a href="https://t.me/+rwHkuKp_cQFlZDll" target="_blank" class="social-icon tg">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram">
    </a>
    
    <a href="https://youtube.com/@helproot" target="_blank" class="social-icon yt">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_%282017%29.svg" alt="YouTube">
    </a>
  </div>
</div>
    <!-- PRODUCTS -->
    <div id="products" class="card hidden">
      <h3>üõíAvailable Xaiomi Accountsüõí</h3>
      <div id="productList" class="list">Loading products...</div>
    </div>

    <!-- MY KEYS -->
    <div id="mykeys" class="card hidden">
      <h3>üîëMy Purchaseüîë</h3>
      <div id="myKeyList">Loading keys...</div>
    </div>

    <!-- BROADCAST -->
    <div id="broadcast" class="card hidden">
      <h3>üì¢Broadcast Offer</h3>
      <p style="color:#6dff9a; margin-bottom:20px;">Send popup notification to ALL users!</p>
      <div class="broadcast-section">
        <input id="broadcastTitleInput" placeholder="Offer Title (e.g. 50% OFF SALE)">
        <textarea id="broadcastMessageInput" placeholder="Offer message... Make it exciting! üéâ"></textarea>
        <button class="action" onclick="sendBroadcast()">üöÄ Send to All Users</button>
      </div>
    </div>

    <!-- VERIFY TRANSACTIONS -->
    <div id="verifyTransactions" class="card hidden">
      <h3>‚úÖPending Payments <span class="pending" id="pendingCount">0</span></h3>
      <div id="transactionList" class="list">Loading pending transactions...</div>
    </div>

    <!-- MANUAL ACCESS -->
    <div id="manualAccess" class="card hidden">
      <h3>üéÅManual Product Access</h3>
      <div class="manual-access-section">
        <input id="manualUserEmail" type="email" placeholder="User Email">
        <input id="manualProductId" placeholder="Product ID (from Manage Products)">
        <button class="action" onclick="giveManualAccess()">üéÅGrant Access</button>
      </div>
    </div>

    <!-- ADD PRODUCT -->
    <div id="addProduct" class="card hidden">
      <h3>‚ûï Add New Product</h3>
      <input id="productName" placeholder="Product Name">
      <input id="productAccessId" placeholder="Access ID">
      <input id="productKey" placeholder="Access Key/Password">
      <input id="productPrice" type="number" placeholder="Price (‚Çπ)">
      <button class="action" onclick="addProduct()">Add Product</button>
    </div>

    <!-- MANAGE USERS -->
    <div id="manageUsers" class="card hidden">
      <h3>üë•Manage Users <span class="ok" id="usersCount">0</span></h3>
      <div id="userManagementList" class="list">Loading users...</div>
    </div>

    <!-- MANAGE PRODUCTS -->
    <div id="manageProducts" class="card hidden">
      <h3>üîßManage Products <span class="ok" id="productsCount">0</span></h3>
      <div id="productManagementList" class="list">Loading products...</div>
    </div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="lock">
  <div class="card">
    <h3>üéõÔ∏èXaiomi Accounts StoreüéõÔ∏è</h3>
    <div style="display:flex;gap:12px;margin-bottom:10px">
      <button class="action" style="flex:1" onclick="showLoginType('user')">Userüë§Login</button>
      <button class="action" style="flex:1;background:#ff6b35" onclick="showLoginType('admin')">AdminüëëLogin</button>
    </div>

    <div id="userLogin">
      <input id="userEmail" type="email" placeholder="Email">
      <input id="userPassword" type="password" placeholder="Password">
      <p style="margin:5px 0;font-size:20px;text-align:center">
      <button class="action" onclick="userLogin()">Login</button>
      <p style="margin:5px 0;font-size:15px;text-align:center">
        <a href="#" onclick="showUserSignup()" style="color:#6dff9a">Register</a> | 
        <a href="#" onclick="showUserForgot()" style="color:#6dff9a">Forget Password</a>
      </p>
    </div>

    <div id="adminLogin" class="hidden">
      <input id="adminEmail" type="email" value="@gmail.com" placeholder="Admin Email">
      <input id="adminPassword" type="password" value="@danger9787" placeholder="Admin Password">
      <p style="margin:5px 0;font-size:20px;text-align:center">
      <button class="action" onclick="adminLogin()">Admin Login</button>
    </div>

    <div id="userSignup" class="hidden">
      <input id="signupEmail" type="email" placeholder="Email">
      <input id="signupPassword" type="password" placeholder="Password">
      <p style="margin:5px 0;font-size:20px;text-align:center">
      <button class="action" onclick="userSignup()">Create Account</button>
    </div>

    <div id="userForgot" class="hidden">
      <input id="forgotEmail" type="email" placeholder="Email">
      <button class="action" onclick="forgotPassword()">Send Reset Link</button>
    </div>

    <p id="msg" class="bad" style="margin-top:15px"></p>
  </div>
</div>

<div id="notify"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCDCijRwIxpHJK0gYmElkocvu8tNKFykpc",
  authDomain: "generalstore-b6e17.firebaseapp.com",
  databaseURL: "https://generalstore-b6e17-default-rtdb.firebaseio.com",
  projectId: "generalstore-b6e17",
  storageBucket: "generalstore-b6e17.firebasestorage.app",
  messagingSenderId: "239645257410",
  appId: "1:239645257410:web:43825aac8e30d15d4f955b",
  measurementId: "G-9YQ7BK5TYT"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null, userRole = 'user', userProducts = [], pendingTransactions = [], allProducts = [];
let editingProductId = null, currentQRProduct = null;

// üî• FIXED BROADCAST - NOW WORKS PERFECTLY
async function sendBroadcast() {
  if (userRole !== 'admin') return notify('‚ùå Admin only!', 'error');

  const title = document.getElementById('broadcastTitleInput').value.trim();
  const message = document.getElementById('broadcastMessageInput').value.trim();

  if (!title || !message) return notify('‚ùå Title aur Message dono bhariye!', 'error');

  try {
    // Ye line database mein "latest_msg" ko naye data se badal degi
    await db.collection('broadcasts').doc("latest_msg").set({
      title: title,
      message: message,
      sentAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: false }); // merge: false matlab purana data poori tarah khatam
    
    notify('‚úÖ Naya message save ho gaya!', 'success');
    
    // Naya message turant dikhane ke liye
    showBroadcast(title, message);
    
    // Inputs saaf karne ke liye
    document.getElementById('broadcastTitleInput').value = '';
    document.getElementById('broadcastMessageInput').value = '';
  } catch (error) {
    console.error("Broadcast error:", error);
    notify('‚ùå Update fail: ' + error.message, 'error');
  }
}


// üî• FIXED CHECK BROADCASTS
// üî• UPDATED: FIXED AUTO-LOAD BROADCAST
async function checkBroadcasts() {
  try {
    // Hum hamesha "latest_msg" wala document hi uthayenge
    const doc = await db.collection('broadcasts').doc("latest_msg").get();
    
    if (doc.exists) {
      const data = doc.data();
      document.getElementById('broadcastTitle').textContent = data.title;
      document.getElementById('broadcastMessage').textContent = data.message;
      document.getElementById('broadcastPopup').style.display = 'block';
      document.getElementById('broadcastPopup').classList.add('show');
    }
  } catch (err) {
    console.log('No saved broadcast');
  }
}




// üî• USERS CAN SUBMIT TX ID - NO PERMISSION ERRORS
async function submitTransaction() {
  const txId = document.getElementById('transactionId').value.trim();
  if (!txId) { notify('‚ùå Enter Transaction ID!', 'error'); return; }
  if (!currentQRProduct) { notify('‚ùå Select a product first!', 'error'); return; }
  try {
    await db.collection('pendingTransactions').add({
      userId: currentUser.uid,
      userEmail: currentUser.email,
      transactionId: txId,
      productId: currentQRProduct,
      status: 'pending',
      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    notify('‚úÖ TX Submitted! Checking status...', 'success');
    closeQRModal();
    showSection('mykeys'); // <-- Ye line user ko status page par le jayegi
  } catch (error) {
    notify(`‚ùå Error: ${error.message}`, 'error');
  }
}


// üî• FIXED LOAD PENDING TRANSACTIONS
// üî• NO INDEX NEEDED - PERFECTLY WORKS!
async function loadPendingTransactions() {
  try {
    document.getElementById('transactionList').innerHTML = 'Loading...';
    
    // üî• SIMPLE QUERY - NO INDEX REQUIRED
    const snapshot = await db.collection('pendingTransactions').get();
    
    // Filter pending transactions in code
    const pendingTx = snapshot.docs.filter(doc => {
      const data = doc.data();
      return data.status === 'pending';
    }).sort((a, b) => {
      // Sort by timestamp (newest first)
      return (b.data().submittedAt?.toMillis() || 0) - (a.data().submittedAt?.toMillis() || 0);
    });

    if (pendingTx.length === 0) {
      document.getElementById('transactionList').innerHTML = 
        '<div class="item"><p style="text-align:center;color:#ffeb3b;">No pending payments</p></div>';
      document.getElementById('pendingCount').textContent = '0';
      return;
    }

    let html = '';
    pendingTx.forEach((doc) => {
      const data = doc.data();
      html += `
        <div class="item" style="border-left:4px solid #ffeb3b;">
          <b>${data.userEmail}</b><br>
          <small>TX ID: ${data.transactionId}</small><br>
          <small>Product: ${data.productId}</small><br>
          <small>Time: ${data.submittedAt ? new Date(data.submittedAt.toDate()).toLocaleString() : 'Now'}</small>
          <div class="row">
            <button class="manual-verify" onclick="verifyTransaction('${doc.id}','${data.userId}','${data.productId}')">
              ‚úÖ VERIFY
            </button>
            <button class="danger" onclick="rejectTransaction('${doc.id}')">‚ùå REJECT</button>
          </div>
        </div>
      `;
    });
    
    document.getElementById('transactionList').innerHTML = html;
    document.getElementById('pendingCount').textContent = pendingTx.length;
    
  } catch(error) {
    console.error('Error:', error);
    document.getElementById('transactionList').innerHTML = `<p class="bad">Error: ${error.message}</p>`;
  }
}
// üî• FIXED VERIFY TRANSACTION WITH SOLD OUT FEATURE
async function verifyTransaction(txId, userId, productId) {
  if (!confirm('Verify this payment and grant access?')) return;
  
  try {
    const batch = db.batch();
    // Transaction ko verified mark karein taaki user ke screen se "Pending" hat jaye
    batch.update(db.collection('pendingTransactions').doc(txId), { 
      status: 'verified', 
      verifiedAt: firebase.firestore.FieldValue.serverTimestamp() 
    });
    
    // User ko product access dein
    batch.update(db.collection('users').doc(userId), { 
      purchasedProducts: firebase.firestore.FieldValue.arrayUnion(productId) 
    });
    
    // Product ko sold out karein
    batch.update(db.collection('products').doc(productId), { 
      isSoldOut: true,
      soldAt: firebase.firestore.FieldValue.serverTimestamp(),
      soldTo: userId
    });
    
    await batch.commit();
    notify('‚úÖ Approved! User can now see credentials.', 'success');
    loadPendingTransactions();
    // UI Update karne ke liye
    if(currentUser.uid === userId) {
        await loadUserData();
        renderMyKeys();
    }
  } catch (err) {
    notify('‚ùå Verification failed: ' + err.message, 'error');
  }
}


async function rejectTransaction(txId) {
  if (!confirm('Reject this transaction?')) return;
  
  try {
    await db.collection('pendingTransactions').doc(txId).update({
      status: 'rejected',
      rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    notify('‚ùå Transaction rejected!', 'success');
    loadPendingTransactions();
  } catch (err) {
    notify('‚ùå Reject failed!', 'error');
  }
}

// üî• FIXED QR MODAL WITH PRODUCT SELECTION
function showQRModal(productId = null) {
  currentQRProduct = productId;
  document.getElementById('qrModal').classList.add('show');
  document.getElementById('transactionId').value = '';
  
  const product = allProducts.find(p => p.id === productId);
  const amount = product ? product.price : 'XXX';
  
  setTimeout(() => {
    new QRCode(document.getElementById('qrCode'), {
      text: `Pay ‚Çπ${amount} to UPI: yourupi@paytm
Product: ${product?.name || 'Selected'}
TX ID: Submit after payment`,
      width: 200,
      height: 200,
      colorDark: "#000000",
      colorLight: "#ffffff"
    });
  }, 100);
}

function closeQRModal() {
  document.getElementById('qrModal').classList.remove('show');
  currentQRProduct = null;
}

function copyToClipboard(text, button) {
  navigator.clipboard.writeText(text).then(() => {
    const originalText = button.textContent;
    button.textContent = '‚úÖ Copied!';
    button.classList.add('copy-success');
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('copy-success');
    }, 2000);
    notify('Copied to clipboard!', 'success');
  }).catch(() => {
    notify('Copy failed!', 'error');
  });
}

// üî• FIXED PRODUCTS LIST WITH SOLD OUT CHECK
// --- NEW SORTING LOGIC FOR PRODUCTS ---
async function renderProductsList() {
  try {
    const snapshot = await db.collection('products').get();
    allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    if (allProducts.length === 0) {
      document.getElementById('productList').innerHTML = '<p>No products available</p>';
      return;
    }

    // üî• DHAYAN SE DEKHO: Ye hai sorting ka magic
    allProducts.sort((a, b) => {
      // 1. Status Check: Jo sold nahi hai (false) wo upar rahega
      if (a.isSoldOut !== b.isSoldOut) {
        return a.isSoldOut ? 1 : -1; 
      }
      // 2. Date Check: Agar dono available hain, toh naya (Latest) upar dikhao
      // Note: Iske liye addProduct mein submittedAt hona zaroori hai
      const dateA = a.submittedAt?.toMillis() || 0;
      const dateB = b.submittedAt?.toMillis() || 0;
      return dateB - dateA; // B - A matlab Latest First
    });

    let html = '';
    allProducts.forEach(p => {
      const isPurchased = userProducts.includes(p.id);
      const isSoldOut = p.isSoldOut || false;
      
      // Date dikhane ke liye format
      const dateStr = p.submittedAt ? new Date(p.submittedAt.toDate()).toLocaleDateString() : 'New';
      
      if (isSoldOut) {
        // --- SOLD OUT LOOK (Niche dikhega) ---
        html += `
          <div class="item" style="opacity: 0.6; border-left: 4px solid #ff4444;">
            <div style="display:flex; justify-content:space-between;">
               <b>${p.name}</b>
               <small style="color:#ff4444; font-weight:bold;">SOLD OUT</small>
            </div>
            <small>Price: ‚Çπ${p.price} | Sold Date: ${dateStr}</small>
          </div>`;
      } else if (isPurchased) {
        // --- PURCHASED LOOK ---
        html += `
          <div class="item" style="border-left: 4px solid #6dff9a;">
            <b>${p.name}</b> <small class="ok">(Purchased)</small><br>
            <button class="action" onclick="showSection('mykeys')" style="padding:5px 10px; font-size:12px; margin-top:10px;">View Access</button>
          </div>`;
      } else {
        // --- AVAILABLE LOOK (Upar dikhega) ---
        html += `
          <div class="item" style="border-left: 4px solid #6d7cff;">
            <div style="display:flex; justify-content:space-between;">
               <b>${p.name}</b>
               <b class="ok">‚Çπ${p.price}</b>
            </div>
            <small>Listed on: ${dateStr}</small><br>
            <div style="margin:0px 0;">
              <button class="action" onclick="showQRModal('${p.id}')">üí≥ Buy Now</button>
            </div>
          </div>`;
      }
    });
    
    document.getElementById('productList').innerHTML = html;
  } catch (err) {
    console.error("Sorting Error:", err);
    document.getElementById('productList').innerHTML = '<p class="bad">Error loading products</p>';
  }
}

// üî• FIXED MY KEYS
async function renderMyKeys() {
  try {
    const keyList = document.getElementById('myKeyList');
    keyList.innerHTML = '<div class="item"><div class="spinner"></div> Loading...</div>';
    
    // 1. Pehle user ke pending payments fetch karein
    const pendingSnapshot = await db.collection('pendingTransactions')
      .where('userId', '==', currentUser.uid)
      .where('status', '==', 'pending')
      .get();

    // 2. Verified products fetch karein
    const productsSnapshot = await db.collection('products').get();
    const products = productsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
    const myPurchased = products.filter(p => userProducts.includes(p.id));

    let html = '';

    // --- PENDING SECTION (Ye naya hai) ---
    if (!pendingSnapshot.empty) {
      html += '<h4 style="color:#ffeb3b; margin: 10px 0;">‚è≥ Verification Pending...... ‚è≥</h4>';
      pendingSnapshot.forEach(doc => {
        const tx = doc.data();
        html += `
          <div class="item" style="border-left: 4px solid #ffeb3b; background: rgba(255,235,59,0.05);">
            <b>Order for Product ID: ${tx.productId}</b><br>
            <small>UTR: ${tx.transactionId}</small>
            <div class="product-creds pending" style="margin-top:8px; font-size:13px;">
               Please wait‚Äîadmin verifying your payment.
            </div>
          </div>
        `;
      });
    }

    // --- PURCHASED SECTION ---
    if (myPurchased.length > 0) {
      html += '<h4 style="color:#6dff9a; margin: 20px 0 10px 0;">‚úÖ My Accounts</h4>';
      myPurchased.forEach(p => {
        const creds = p.loginId || p.key || 'N/A';
        html += `
          <div class="item">
            <b>${p.name}</b>
            <div class="product-creds">
              <b>üÜî ID:</b> <span class="ok">${p.loginId}</span>
              <div class="copy-row">
                <button class="copy-btn" onclick="copyToClipboard('${p.loginId}', this)">Copy ID</button>
              </div>
              ${p.key ? `<b>üîë Key:</b> <span class="ok">${p.key}</span><div class="copy-row"><button class="copy-btn" onclick="copyToClipboard('${p.key}', this)">Copy Key</button></div>` : ''}
            </div>
          </div>
        `;
      });
    }

    if (pendingSnapshot.empty && myPurchased.length === 0) {
      html = '<div class="item" style="text-align:center;"><p class="bad">Purchases or pending requests were not found.</p></div>';
    }

    keyList.innerHTML = html;
  } catch(err) {
    console.error(err);
    document.getElementById('myKeyList').innerHTML = '<div class="item"><p class="bad">Error loading data</p></div>';
  }
}



// üî• FIXED LOAD USER DATA
async function loadUserData() {
  try {
    // 1. User ka data aur role check karna
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if(userDoc.exists) {
      const data = userDoc.data();
      userRole = data.role || 'user';
      userProducts = data.purchasedProducts || [];
    }
    
    // 2. Sidemenu mein Name aur Role set karna (Gmail se naam nikal kar)
    const displayName = currentUser.email.split('@')[0].toUpperCase();
    document.getElementById('userType').innerHTML = `
      <div style="text-align:left; padding-left:10px;">
        <span style="font-size:18px; color:#fff;">üë§${displayName}‚úÖ</span><br>
        <span style="font-size:14px; color:#6dff9a;">${userRole === 'admin' ? 'üëë ADMIN PANEL' : '   User Panel'}</span>
      </div>
    `;

    // 3. DASHBOARD FIX: Admin aur User ke liye alag logic
    const allProductsSnap = await db.collection('products').get(); // Saare accounts
    const availableProductsSnap = await db.collection('products').where('isSoldOut', '==', false).get(); // Khali available

    if (userRole === 'admin') {
      // Admin ko dashboard par total (bikay huye + available) saare dikhao
      document.getElementById('totalProducts').textContent = allProductsSnap.size;
    } else {
      // User ko sirf wahi dikhao jo abhi stock mein hain
      document.getElementById('totalProducts').textContent = availableProductsSnap.size;
    }

    // 4. Baki stats update karna
    document.getElementById('userInfo').textContent = currentUser.email;
    document.getElementById('roleBadge').textContent = userRole.toUpperCase();
    document.getElementById('userKeys').textContent = userProducts.length;
    
    // 5. Admin/User ke buttons show-hide karna
    if(userRole === 'admin') {
      document.getElementById('adminSection').classList.remove('hidden');
      document.getElementById('userSection').classList.add('hidden');
    } else {
      document.getElementById('userSection').classList.remove('hidden');
      document.getElementById('adminSection').classList.add('hidden');
    }

  } catch(err) {
    console.error("Dashboard Error:", err);
  }
}



// üî• ALL OTHER FUNCTIONS (UNCHANGED BUT WORKING)
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menuBtn');
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    openSidebar();
  }
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('show'); // Overlay dikhao
  document.getElementById('menuBtn').classList.add('hidden');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show'); // Overlay chupao
  document.getElementById('menuBtn').classList.remove('hidden');
}


function showSection(id, fromNav = false) {
  closeSidebar();
  document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  
  if (fromNav && event?.target) {
    document.querySelectorAll('.nav-active').forEach(btn => btn.classList.remove('nav-active'));
    event.target.classList.add('nav-active');
  }
  
  if(id === 'products') renderProductsList();
  if(id === 'mykeys') renderMyKeys();
  if(id === 'manageUsers') loadUserManagement();
  if(id === 'manageProducts') loadProductManagement();
  if(id === 'verifyTransactions') loadPendingTransactions();
}

function notify(msg, type='success'){
  const n = document.getElementById("notify");
  n.textContent = msg;
  n.style.background = type==='success' ? '#6dff9a' : '#ff7b7b';
  n.style.display = "block";
  setTimeout(()=>n.style.display = "none", 4000);
}

function showBroadcast(title, message) {
  document.getElementById('broadcastTitle').textContent = title;
  document.getElementById('broadcastMessage').textContent = message;
  document.getElementById('broadcastPopup').classList.add('show');
}

function closeBroadcast() {
  document.getElementById('broadcastPopup').classList.remove('show');
}








function showLoginType(type) {
  ['userLogin','adminLogin','userSignup','userForgot'].forEach(id => {
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(type === 'user' ? 'userLogin' : 'adminLogin').classList.remove('hidden');
}

async function userLogin() {
  try {
    await auth.signInWithEmailAndPassword(
      document.getElementById('userEmail').value, 
      document.getElementById('userPassword').value
    );
  } catch(err) {
    document.getElementById('msg').textContent = err.message;
    document.getElementById('msg').className = 'bad';
  }
}

async function adminLogin() {
  try {
    await auth.signInWithEmailAndPassword(
      document.getElementById('adminEmail').value, 
      document.getElementById('adminPassword').value
    );
  } catch(err) {
    document.getElementById('msg').textContent = 'Admin login failed!';
    document.getElementById('msg').className = 'bad';
  }
}

async function userSignup() {
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(
      document.getElementById('signupEmail').value, 
      document.getElementById('signupPassword').value
    );
    await db.collection('users').doc(userCredential.user.uid).set({
      email: document.getElementById('signupEmail').value,
      role: 'user',
      purchasedProducts: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    notify('Account created successfully!');
  } catch(err) {
    document.getElementById('msg').textContent = err.message;
    document.getElementById('msg').className = 'bad';
  }
}

async function forgotPassword() {
  try {
    await auth.sendPasswordResetEmail(document.getElementById('forgotEmail').value);
    notify('Reset email sent!');
  } catch(err) {
    document.getElementById('msg').textContent = err.message;
    document.getElementById('msg').className = 'bad';
  }
}

// 1. Logout Function
function logout() {
  auth.signOut().then(() => {
    location.reload(); 
  }).catch((err) => {
    console.error("Logout Error:", err);
  });
  closeSidebar();
}

// 2. Login Status Check (Isse Dashboard aur Broadcast khulega)
auth.onAuthStateChanged(async(user) => {
  if(user) {
    currentUser = user;
    await loadUserData(); // Dashboard ka data load hoga
    unlockApp();          // App khulega
    checkBroadcasts();    // üëà Ye line database se saved message uthayegi
  } else {
    showLockScreen();     // Login page dikhega
  }
});

// 3. App Unlock logic
function unlockApp() {
  document.body.classList.remove('login-mode');
  document.getElementById('lock').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  showSection('dashboard');
}

// 4. Lock Screen logic
function showLockScreen() {
  document.body.classList.add('login-mode');
  document.getElementById('lock').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  showLoginType('user');
}

// 5. Broadcast Popup Band karne ka function
function closeBroadcast() {
  const popup = document.getElementById('broadcastPopup');
  popup.style.display = 'none';
  popup.classList.remove('show');
}

// 6. User Signup/Forgot Password toggles
function showUserSignup() {
  document.getElementById('userSignup').classList.remove('hidden');
  document.getElementById('userLogin').classList.add('hidden');
}

function showUserForgot() {
  document.getElementById('userForgot').classList.remove('hidden');
  document.getElementById('userLogin').classList.add('hidden');
}
// Admin functions
async function giveManualAccess() {
  if (userRole !== 'admin') {
    notify('‚ùå Admin only!', 'error');
    return;
  }
  const userEmail = document.getElementById('manualUserEmail').value.trim();
  const productId = document.getElementById('manualProductId').value.trim();
  if (!userEmail || !productId) {
    notify('‚ùå Enter both email & product ID!', 'error');
    return;
  }
  try {
    const usersSnapshot = await db.collection('users').where('email', '==', userEmail).get();
    if (usersSnapshot.empty) {
      notify('‚ùå User not found!', 'error');
      return;
    }
    const userDoc = usersSnapshot.docs[0];
    await db.collection('users').doc(userDoc.id).update({
      purchasedProducts: firebase.firestore.FieldValue.arrayUnion(productId)
    });
    // Mark product as sold out
    await db.collection('products').doc(productId).update({
      isSoldOut: true,
      soldAt: firebase.firestore.FieldValue.serverTimestamp(),
      soldTo: userDoc.id
    });
    notify(`‚úÖ Access granted to ${userEmail}! Product marked SOLD OUT`, 'success');
    document.getElementById('manualUserEmail').value = '';
    document.getElementById('manualProductId').value = '';
    renderProductsList();
  } catch (err) {
    notify('‚ùå Failed to grant access!', 'error');
  }
}

// üî• PERFECTLY FIXED - NO MORE "Error loading users"
async function loadUserManagement() {
  if (userRole !== 'admin') {
    notify('‚ùå Admin only!', 'error');
    return;
  }
  
  try {
    document.getElementById('userManagementList').innerHTML = 'Loading users...';
    
    // üî• ADMIN CAN READ ALL USERS WITH PROPER SECURITY
    const snapshot = await db.collection('users').get();
    
    if (snapshot.empty) {
      document.getElementById('userManagementList').innerHTML = '<div class="item"><p class="bad">No users found</p></div>';
      document.getElementById('usersCount').textContent = '0';
      return;
    }
    
    let html = '';
    snapshot.docs.forEach(doc => {
      const u = doc.data();
      const productsCount = u.purchasedProducts?.length || 0;
      const productsPreview = u.purchasedProducts?.slice(0, 3).join(', ') || 'None';
      
      html += `
        <div class="item">
          <b>${u.email || 'No email'}</b> 
          <span style="color: ${u.role === 'admin' ? '#ff6b35' : '#6dff9a'}">
            ${u.role === 'admin' ? 'üëëADMIN' : 'üë§USER'}
          </span><br>
          <small>Purchases: ${productsCount} | 
            Products: ${productsPreview}${productsCount > 3 ? '...' : ''}
          </small><br>
          <div class="row">
            <button class="action" onclick="editUser('${doc.id}')">Edit</button>
          <button class="danger" onclick="deleteUser('${doc.id}')">Delete</button>
          </div>
        </div>
      `;
    });
    
    document.getElementById('userManagementList').innerHTML = html;
    document.getElementById('usersCount').textContent = snapshot.size;
    
    
  } catch(err) {
    console.error('User management error:', err);
    document.getElementById('userManagementList').innerHTML = 
      `<div class="item"><p class="bad">Error: ${err.message}</p></div>`;
  }
}

async function loadProductManagement() {
  try {
    document.getElementById('productManagementList').innerHTML = 'Loading products...';
    const snapshot = await db.collection('products').get();
    if(snapshot.empty) {
      document.getElementById('productManagementList').innerHTML = '<p class="bad">No products found</p>';
      document.getElementById('productsCount').textContent = '0';
      return;
    }
    let html = '';
    snapshot.docs.forEach(doc => {
      const p = doc.data();
      const status = p.isSoldOut ? 'üî¥ SOLD OUT' : 'üü¢ Available';
      html += `<div class="item">
        <b>${p.name}</b> ${status}<br>
        <small>ID: <span class="ok">${doc.id}</span> | Key: ${p.key} | Price: ‚Çπ${p.price}</small><br>
        <div class="row">
          <button class="action" onclick="editProduct('${doc.id}','${p.name}','${p.loginId}','${p.key}',${p.price})">Edit</button>
          <button class="danger" onclick="deleteProduct('${doc.id}')">Delete</button>
        </div>
      </div>`;
    });
    document.getElementById('productManagementList').innerHTML = html;
    document.getElementById('productsCount').textContent = snapshot.size;
  } catch(err) {
    document.getElementById('productManagementList').innerHTML = '<p class="bad">Error loading products</p>';
  }
}

async function addProduct() {
  const name = document.getElementById('productName').value;
  const accessId = document.getElementById('productAccessId').value;
  const key = document.getElementById('productKey').value;
  const price = parseInt(document.getElementById('productPrice').value);

  if (!name || !accessId || !key || !price) {
    return notify('Fill all fields!', 'error');
  }

  try {
    if (editingProductId) {
      await db.collection('products').doc(editingProductId).update({
        name, loginId: accessId, key, price
      });
      notify('‚úÖ Product updated!');
      editingProductId = null;
    } else {
      await db.collection('products').add({
    name: name, 
    loginId: accessId, 
    key: key, 
    price: price, 
    isSoldOut: false,
    submittedAt: firebase.firestore.FieldValue.serverTimestamp() // üî• Ye line date record karegi
  });
      notify('‚úÖ Product added!');
    }

    document.getElementById('productName').value = '';
    document.getElementById('productAccessId').value = '';
    document.getElementById('productKey').value = '';
    document.getElementById('productPrice').value = '';

    loadUserData();
    renderProductsList();
  } catch (err) {
    notify('Error adding product!', 'error');
  }
}

function editProduct(productId, name, accessId, key, price) {
  editingProductId = productId;
  document.getElementById('productName').value = name;
  document.getElementById('productAccessId').value = accessId;
  document.getElementById('productKey').value = key;
  document.getElementById('productPrice').value = price;
  showSection('addProduct');
  notify(`Editing: ${name}`);
}

async function deleteUser(userId) {
  if(!confirm('Delete this user?')) return;
  try {
    await db.collection('users').doc(userId).delete();
    notify('‚úÖ User deleted!');
    loadUserManagement();
  } catch(err) {
    notify('Delete failed!', 'error');
  }
}

async function deleteProduct(productId) {
  if(!confirm('Delete this product?')) return;
  try {
    await db.collection('products').doc(productId).delete();
    notify('‚úÖ Product deleted!');
    loadProductManagement();
    loadUserData();
    renderProductsList();
  } catch(err) {
    notify('Delete failed!', 'error');
  }
}

function editUser(userId) {
  notify('Edit user coming soon!');
}
</script>
</body>
</html>
