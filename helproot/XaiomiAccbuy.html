<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bootloader Unlock Permission Account Buy Online</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
/* [ALL YOUR EXISTING STYLES REMAIN SAME - NO CHANGES NEEDED] */
* {box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html, body {height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#0f1220; color:#eaeaf0; overflow-x:hidden;}
body {padding-bottom: env(safe-area-inset-bottom);}


/* Dashboard card ko position relative dena zaroori hai */
#dashboard {
  position: relative;
}

.support-btn {
  position: absolute; /* Fixed ki jagah absolute */
  top: 15px; 
  right: 15px;
  width: 40px;
  height: 40px;
  background: #25D366; 
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
  z-index: 10;
  border: 2px solid #fff;
  text-decoration: none;
}

.support-btn img {
  width: 28px;
    height: 28px;
}

/* Mobile par agar dashboard chota hai toh adjustment */
@media (max-width: 768px) {
  .support-btn {
   top: 5px;
    right: 5px;
    width: 45px;
    height: 45px;
  }
}

/* Live Indicator Animation */
.live-dot {
  height: 8px;
  width: 8px;
  background-color: #6dff9a;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
  box-shadow: 0 0 8px #6dff9a;
  animation: blink-live 1.5s infinite;
}

@keyframes blink-live {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(1.2); }
  100% { opacity: 1; transform: scale(1); }
}

.live-status {
  font-size: 11px;
  color: #6dff9a;
  font-weight: bold;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 10px;
}




.social-links {
  border-top: 1px solid rgba(255,255,255,0.1);
  margin-top: 15px;
  padding-top: 5px;
}

.social-icon {
  width: 45px;
  height: 45px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  background: rgba(255,255,255,0.05);
}

.social-icon img {
  width: 25px;
  height: 25px;
}

/* Hover Effects */
.social-icon:hover {
  transform: translateY(-3px);
  background: rgba(255,255,255,0.1);
}

.social-icon.tg:hover {
  box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
}

.social-icon.yt:hover {
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}





#lock {
  max-width: 100%;
  width: 100%;
  margin: 0;
  border-radius: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center; /* yaha se aap login page ko up down center kar sakte bas end ko change karna i */
  padding: 30px;
  padding-top: 150px;
  position: relative; /* Overlay ke liye zaroori hai */
  overflow: hidden;

  /* Background Wallpaper */
  background: url('https://helproot.github.io/images/wallpaper-2.png');
  background-size: cover;
  background-position: center;
}

/* Card ko blur ke upar dikhane ke liye */
#lock .card {
  position: relative;
  z-index: 2; /* Blur layer se upar rakhne ke liye */
  background: rgba(27, 31, 59, 0.6);
  backdrop-filter: blur(7px); /* Card ke andar extra depth */
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
  border-radius: 30px; /* Thoda zyada rounded modern look ke liye */
}



button {padding:14px 20px; margin:8px 0; border:0; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; min-height:48px; touch-action:manipulation;}
.action {background:#6d7cff; color:#fff;}
.action:hover {background:#5a6de6;}
.danger {background:#ff4444; color:#fff;}
.danger:hover {background:#e63939;}
.admin-only {background:#ff6b35 !important;}
.manual-give {background:#00d4aa !important; color:#000;}
.manual-verify {background:#ffeb3b !important; color:#000;}
.sold-out {background:#ff4444 !important; color:#fff !important;}

#qrModal {position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:1000; display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px;}
#qrModal.show {display:flex;}
.qr-container {background:#1b1f3b; padding:30px; border-radius:24px; text-align:center; box-shadow:0 25px 50px rgba(0,0,0,0.6);}
#qrCode {margin:20px 0; border-radius:16px; background:#fff; padding:10px;}
.qr-close {position:absolute; top:20px; right:20px; background:#ff4444; color:#fff; border:none; border-radius:50%; width:50px; height:50px; font-size:20px; cursor:pointer;}

.broadcast-popup {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg, #ff6b35, #ff8e53); color:#fff; padding:30px; border-radius:24px; max-width:90vw; max-height:80vh; z-index:999; display:none; box-shadow:0 30px 60px rgba(255,107,53,0.4); text-align:center; backdrop-filter:blur(20px);}
.broadcast-popup.show {display:block; animation:popupSlide 0.4s cubic-bezier(0.4,0,0.2,1);}
.broadcast-popup h3 {margin:0 0 15px 0; font-size:24px;}
.broadcast-popup p {font-size:16px; line-height:1.5; margin-bottom:25px;}
.broadcast-close {background:#fff; color:#ff6b35; border:none; padding:12px 30px; border-radius:25px; font-weight:700; font-size:16px; cursor:pointer;}
@keyframes popupSlide {from {opacity:0; transform:translate(-50%,-60%) scale(0.9);} to {opacity:1; transform:translate(-50%,-50%) scale(1);}}

input {padding:16px; margin:10px 0; border-radius:12px; border:1px solid #2a2f4a; background:#1b1f3b; color:#fff; font-size:16px; width:100%;}
input::placeholder {color:#8a8fc4;}
input:focus {outline:none; border-color:#6d7cff; box-shadow:0 0 0 3px rgba(109,124,255,0.2);}



#toast {
  visibility: hidden;
  min-width: 300px;
  background-color: #1b1f3b; 
  color: #ffffff;
  text-align: center;
  border-radius: 15px;
  padding: 16px;
  
  /* Ye 3 lines sabse important hain */
  position: fixed; 
  z-index: 999999 !important; /* Isse ye har ek cheez ke upar aa jayega */
  bottom: 10%; /* Screen ke niche se 10% upar */
  
  left: 50%;
  transform: translateX(-50%);
  border: 2px solid #6d7cff;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.8), 0 0 15px rgba(109, 124, 255, 0.5);
  font-size: 14px;
  font-weight: 600;
  backdrop-filter: none !important; /* Ispe khud pe blur mat lagao taaki saaf dikhe */
}

#toast.show {
  visibility: visible;
  animation: fadein 0.5s ease-out;
}

@keyframes fadein {
  from { bottom: 0; opacity: 0; }
  to { bottom: 10%; opacity: 1; }
}





/* --- COMPACT MOBILE NAV CSS --- */
#mobileBottomNav {
  position: fixed; 
  bottom: 0; 
  left: 0; 
  right: 0; 
  background: #15193a; 
  display: flex; 
  z-index: 100; 
  padding: 5px 10px; /* Padding kam ki */
  box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
  height: 60px; /* Fixed height set ki */
  align-items: center;
}

.nav-item {
  flex: 1; 
  text-align: center; 
  padding: 0 4px; /* Side gap kam kiya */
}

.nav-item button {
  width: 100%; 
  font-size: 20px; /* Icon thoda bada */
  padding: 8px 0; /* Button ke andar space kam ki */
  border-radius: 12px; 
  min-height: 40px; /* Height reduce ki */
  background: transparent; /* Default transparent */
}

.nav-active {
  background: #6d7cff !important; 
  color: white;
  box-shadow: 0 4px 10px rgba(109,124,255,0.3);
}
/* Profile Card: Vertical Layout */
.profile-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 20px 10px;
  margin-bottom: 25px;
  display: flex;
  flex-direction: column; 
  align-items: center;    
  text-align: center;
  gap: 12px;
  width: 100%; /* Sidebar ki width ke barabar */
}

.avatar-wrapper {
  position: relative;
  display: inline-block;
  width: 40px; /* Aapke purane code ki height ke barabar */
  height: 40px;
}

.profile-img {
  width: 50px !important; /* Size thoda badhaya */
  height: 50px !important;
  border-radius: 50%;
  overflow: hidden; /* Ye zaroori hai photo ko gol rakhne ke liye */
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #6d7cff, #a5b1ff);
  border: 2px solid rgba(255,255,255,0.1);
}

.profile-img img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* Photo ko perfect fit karega */
}

.sidebar {
  position:fixed; left:-280px; top:0; width:180px; height:100vh; 
  background:#15193a; z-index:200; padding:20px; 
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1); 
  overflow-y:auto; box-shadow:2px 0 15px rgba(0,0,0,0.4);
  display: flex; /* Naya add kiya */
  flex-direction: column; /* Naya add kiya */
}

/* üî• Blinking Green Dot Fixed */
.status-indicator {
  position: absolute;
  bottom: 0px;
  right: 0px;
  width: 12px;
  height: 12px;
  background: #6dff9a;
  border: 2px solid #15193a;
  border-radius: 50%;
  /* Animation call */
  animation: pulse-dot 1.5s infinite ease-in-out;
}

/* Animation Keyframes */
@keyframes pulse-dot {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(109, 255, 154, 0.7); }
  70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(109, 255, 154, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(109, 255, 154, 0); }
}

.profile-details {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

.u-name {
  font-size: 15px; /* Thoda scannable size */
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 4px;
  width: 90%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.u-role {
  font-size: 9px;
  font-weight: 700;
  color: #6dff9a;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}



.sidebar {position:fixed; left:-280px; top:0; width:180px; height:100vh; background:#15193a; z-index:200; padding:20px; transition:all 0.3s cubic-bezier(0.4,0,0.2,1); overflow-y:auto; box-shadow:2px 0 15px rgba(0,0,0,0.4);}
.sidebar.open {left:0;}
.sidebar-overlay {
  position:fixed; top:0; left:0; right:0; bottom:0; 
  background:rgba(0,0,0,0.6); z-index:150; 
  display:none; 
  backdrop-filter: blur(3px); /* Thoda blur effect */
}
.sidebar-overlay.show {
  display:block !important; /* Jab active hoga tab dikhega */
}

.sidebar h3 {margin:0 0 25px 0; font-size:20px;}
.sidebar button {width:100%; margin:8px 0; padding:14px; border-radius:12px; text-align:left; font-size:15px; transition:background 0.2s ease;}
.sidebar button:hover {background:#2f36a3;}





.main{ flex:1; padding:14px; padding-bottom:110px; overflow-y:auto; display:flex; flex-direction:column; align-items:center;}
.card{ width:100%; max-width:520px; background:linear-gradient(180deg,#1b1f3b,#141735); border-radius:22px; padding:22px 18px; margin:12px 0; box-shadow:0 15px 45px rgba(0,0,0,.45);}
.card h3{ margin:0 0 18px 0; font-size:20px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:10px; text-align:center;}

.stats-grid{ width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:10px;}
.stat-card{ background:linear-gradient(135deg,#2b3080,#1f245c); padding:18px 10px; border-radius:18px; text-align:center; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);}
.stat-card b{ display:block; font-size:11px; letter-spacing:.5px; opacity:.75; margin-bottom:6px;}
.stat-card span{ font-size:20px; font-weight:700;}
.ok{color:#6dff9a}
.bad{color:#ff7b7b}
.pending{color:#ffeb3b}

.copy-btn {background:#00d4aa !important; color:#000 !important; font-size:14px; padding:8px 16px; margin:2px; border-radius:8px; font-weight:600;}
.copy-btn:hover {background:#00b894 !important;}
.copy-success {background:#6dff9a !important; color:#000 !important; animation:copyPulse 0.3s ease;}

@keyframes copyPulse {0%,100%{transform:scale(1);} 50%{transform:scale(1.05);}}

@media(min-width:768px){
  .stats-grid{ grid-template-columns:repeat(4,1fr);}
  .app-container {flex-direction:row;}
  .sidebar {left:0; width:260px; z-index:1;}
  .sidebar-overlay {display:none !important;}
  #mobileBottomNav {display:none;}
  .main {padding:10px; padding-left:295px; padding-bottom:30px;}
  #menuBtn {display:none;}
  #lock {max-width:500px; margin:50px auto; height:auto;}
  .card {max-width:700px;}
}

@media (max-width: 480px) {
  .main {padding:15px;}
  .card {padding:20px; margin:10px 0;}
  button {padding:16px; font-size:17px;}
  input {padding:18px;}
}

.list .item {background:#23286a; border-radius:16px; padding:20px; margin:15px 0;}
.row {display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;}
.row button {flex:1; min-width:100px;}

.product-creds { background: linear-gradient(135deg, #1a3a1a, #2d5a2d); border: 1px solid #4a9a4a; border-radius: 12px; padding: 15px; margin: 10px 0; }
.product-creds.pending { background: linear-gradient(135deg, #ffeb3b, #ffd54f); border: 1px solid #fbc02d; color: #000; }
.product-creds b { color: #6dff9a; font-size: 16px; }
.product-creds.pending b { color: #000; }
.product-creds .copy-row {display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
.product-creds .copy-row button {flex:1; min-width:80px;}

#notify {position:fixed; top:20px; right:20px; left:20px; max-width:400px; margin:0 auto; background:#6d7cff; color:#fff; padding:16px 20px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.4); display:none; z-index:9999; font-weight:500;}
.hidden {display:none !important;}

body.login-mode #menuBtn, body.login-mode #sidebar, body.login-mode #mobileBottomNav { display: none !important;}

#menuBtn {position:fixed; top:20px; left:20px; z-index:250; background:#6d7cff; border:none; border-radius:12px; width:50px; height:50px; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all 0.25s cubic-bezier(0.4,0,0.2,1);}
#menuBtn.hidden {opacity:0; transform:scale(0.8); pointer-events:none;}

.manual-access-section { background: linear-gradient(135deg, #00d4aa, #00a085); border-radius: 16px; padding: 20px; margin: 15px 0; }
.manual-access-section input { background: rgba(255,255,255,0.95); color: #000; border: 2px solid #00d4aa; }
.manual-access-section button { background: #000 !important; color: #00d4aa !important; font-weight: 700; border: 2px solid #00d4aa; }

.broadcast-section {background: linear-gradient(135deg, #ff6b35, #ff8e53); border-radius:16px; padding:20px; margin:15px 0;}
.broadcast-section textarea {width:100%; height:120px; background:rgba(255,255,255,0.95); color:#000; border-radius:12px; border:2px solid #ff6b35; padding:15px; font-size:16px; resize:vertical;}

.transaction-section {background: linear-gradient(135deg, #ffeb3b, #ffd54f); border-radius:16px; padding:20px; margin:15px 0;}
.transaction-section input { background: rgba(0,0,0,0.9); color: #fff; border: 2px solid #ffeb3b; }
.product-creds.pending { 
  background: linear-gradient(135deg, #444, #222) !important; 
  border: 1px dashed #ffeb3b !important; 
  color: #ffeb3b !important; 
}


let currentUser = null;
let currentProductPrice = 0; // Ye add karein
let currentQRProduct = null;  // Ye add karein

</style>
</head>
<body>
<audio id="successPing" src="https://www.soundjay.com/buttons/sounds/button-37a.mp3" preload="auto"></audio>
<div id="toast">If UPI apps are not open, kindly scan the QR code.</div>

<!-- BROADCAST POPUP -->
<div id="broadcastPopup" class="broadcast-popup">
  <h3 id="broadcastTitle">üéâNEW YEAR SPECIAL OFFER!</h3>
  <p id="broadcastMessage">Get 50% OFF on all premium accounts today only!</p>
  <button class="broadcast-close" onclick="closeBroadcast()">Got it! üéÅ</button>
</div>

<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center;">
    
    <div class="qr-container" style="background:#1b1f3b; padding:25px; border-radius:20px; text-align:center; position:relative; width:90%; max-width:380px; border:1px solid #2a2f4a;">
        
        <button class="qr-close" onclick="closeQRModal()" style="position:absolute; top:10px; right:15px; background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">‚úï</button>
        
        <h3 style="margin-top:0; color:#fff;">Pay with UPI</h3>
        
        <div style="position:relative; display:inline-block; margin-bottom:15px; background:#fff; padding:10px; border-radius:12px;">
            <img src="https://helproot.github.io/images/qr.png" style="width:180px; display:block; border-radius:5px;">
            
            <a href="https://helproot.github.io/images/qr.png" download="PaymentQR.png" 
               style="position:absolute; bottom:5px; right:5px; background:#ffda6a; width:30px; height:30px; line-height:30px; border-radius:50%; text-decoration:none; color:#000; font-size:14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
               ‚¨áÔ∏è
            </a>
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="handleUPIPayment()" style="background:#00d4aa; color:white; border:none; padding:14px; border-radius:12px; font-weight:bold; cursor:pointer; width:100%; font-size:15px;">
                üöÄPay with PhonePe/GPay/Paytm
            </button>
        </div>

        
            <p style="font-size:13px; color:#aaa; margin-bottom:10px;">Enter 12 Digit UTR / Ref. Number:</p>
            
            <input id="transactionId" type="text" maxlength="12" placeholder="e.g. 412345678901" 
                   style="width:100%; padding:12px; border-radius:10px; border:1px solid #3d4465; background:#15193a; color:white; text-align:center; font-size:16px; margin-bottom:10px;">
            
            <button class="action" onclick="submitTransaction()" style="width:100%; background:#6d7cff; color:#fff; border:none; padding:12px; border-radius:10px; font-weight:bold;">
              Submit Transaction‚úÖ
            </button>
        </div>

        <p style="font-size:13px; color:#ffda6a; margin-top:15px; font-weight:500;">
          ‚è≥Admin will verify within 5m‚è≥
        </p>
    </div>
</div>

<script>
function copyUPI() {
  const upi = document.getElementById("upiId").innerText;
  navigator.clipboard.writeText(upi);
  alert("UPI ID copied: " + upi);
}

</script>

<button id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
<div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

<div id="app" class="app-container hidden">
  <div id="mobileBottomNav">
    <div class="nav-item"><button class="nav-active" onclick="showSection('dashboard', true)">üìä</button></div>
    <div class="nav-item"><button onclick="showSection('products', true)">üõí</button></div>
    <div class="nav-item"><button onclick="showSection('mykeys', true)">üîë</button></div>
    <div class="nav-item"><button onclick="showSection('settings')">‚öôÔ∏è</button></div>
  </div>

<div class="sidebar" id="sidebar">
    <div class="profile-card">
      <div class="avatar-wrapper">
        <div class="profile-img" id="sideAvatar">U</div>
        <div class="status-indicator"></div> 
      </div>
      
      
      <div class="profile-details">
        <span class="u-name" id="sideName">Guest</span>
        <span class="u-role" id="sideRole">User Account</span>
      </div>
    </div>

    <button onclick="showSection('dashboard')">üìäDashboard</button>
    <button onclick="showSection('products')">üõíAccounts</button>
    
    <div id="userSection">
      <button onclick="showSection('mykeys')">üîëMy Purchase</button>
      
      
    </div>

    <div id="adminSection" class="hidden">
      <button class="admin-only" onclick="showSection('manageProducts')">üîßManage Acc</button>
      <button class="admin-only" onclick="showSection('manageUsers')">Manageüë•Users</button>
      <button class="admin-only manual-verify" onclick="showSection('verifyTransactions')">‚úÖ Payments</button>
      <button class="admin-only" onclick="showSection('addProduct')">‚ûïAdd Acc</button>
      <button class="admin-only" onclick="showSection('broadcast')">üì¢Broadcast</button>
      <button class="admin-only" onclick="showSection('manualAccess')">üéÅAccessüéÅ</button>
      
    </div>

    <button onclick="showSection('settings')">‚öôÔ∏èSettings</button>
</div>





<div class="main">

  <div id="dashboard" class="card">
    
    <a href="https://wa.me/918051450233?text=Hlw%Sir%20I%20need%20help" target="_blank" class="support-btn" title="Contact Support">
      <img src="https://cdn-icons-png.flaticon.com/512/3670/3670051.png" alt="Support">
    </a>

    <div style="text-align:center; padding: 10px 0 20px 0;">
  <h3 style="margin: 0; font-size: 20px; color: #fff; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase;">
    <span style="color: #6d7cff;">üìä</span> Dashboard <span style="color: #6d7cff;">üìä</span>
  </h3>
</div>

<div class="stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 5px;">
  
  <div style="background: linear-gradient(145deg, rgba(35, 42, 94, 0.9), rgba(21, 25, 58, 0.9)); border: 1px solid rgba(109, 124, 255, 0.15); border-radius: 22px; padding: 18px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <div style="background: rgba(109, 124, 255, 0.1); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto;">
       <span style="font-size: 16px;">üìß</span>
    </div>
    <b id="userInfo" style="font-size: 12px; color: #fff; word-break: break-all; display: block; min-height: 32px; line-height: 1.4;">Loading...</b>
    <small style="color: #a5b1ff; opacity: 0.5; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">User Email</small>
  </div>

  <div style="background: linear-gradient(145deg, rgba(35, 42, 94, 0.9), rgba(21, 25, 58, 0.9)); border: 1px solid rgba(109, 124, 255, 0.15); border-radius: 22px; padding: 18px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <div style="background: rgba(109, 255, 154, 0.1); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto;">
       <span style="font-size: 16px;">üõ°Ô∏è</span>
    </div>
    <b id="roleBadge" class="ok" style="font-size: 15px; color: #6dff9a; display: block; margin-bottom: 5px; font-weight: 800;">Loading...</b>
    <small style="color: #a5b1ff; opacity: 0.5; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Account Role</small>
  </div>

  <div onclick="showSection('products')" style="background: linear-gradient(145deg, #2b357a, #1a214d); border: 1px solid rgba(109, 124, 255, 0.4); border-radius: 22px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 20px rgba(109, 124, 255, 0.15);" onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#6d7cff';" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(109, 124, 255, 0.4)';">
    <div style="font-size: 10px; color: #6dff9a; margin-bottom: 5px; font-weight: 800;">LIVE STOCK</div>
    <b id="totalProducts" style="font-size: 28px; color: #fff; display: block; line-height: 1;">0</b>
    <small style="color: #fff; font-weight: 700; font-size: 11px; margin-top: 8px; display: block; opacity: 0.9;">Total Accounts</small>
  </div>

  <div onclick="showSection('mykeys')" style="background: linear-gradient(145deg, #2b357a, #1a214d); border: 1px solid rgba(109, 124, 255, 0.4); border-radius: 22px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 20px rgba(109, 124, 255, 0.15);" onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#6d7cff';" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(109, 124, 255, 0.4)';">
    <div style="font-size: 10px; color: #ffeb3b; margin-bottom: 5px; font-weight: 800;">OWNED</div>
    <b id="userKeys" style="font-size: 28px; color: #fff; display: block; line-height: 1;">0</b>
    <small style="color: #fff; font-weight: 700; font-size: 11px; margin-top: 8px; display: block; opacity: 0.9;">My Purchases</small>
  </div>

</div> 

<div style="margin-top: 25px; background: rgba(109, 124, 255, 0.05); border-radius: 15px; padding: 15px; border: 1px dashed rgba(109, 124, 255, 0.2);">
  <p style="font-size: 13px; color: #a5b1ff; line-height: 1.5; margin: 0; text-align: center; font-style: italic;">
    "Unlock the true potential of your Xiaomi device with our verified bootloader accounts."
  </p>
</div>





    <div class="social-links" style="margin-top: 10px;">
      <p style="font-size: 11px; opacity: 0.5; margin-bottom: 12px; text-align: center; letter-spacing: 1px;">FOLLOW US</p>
      
      <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
        <a href="https://t.me/+rwHkuKp_cQFlZDll" target="_blank" class="social-icon tg">
          <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" style="width: 30px; height: 30px;">
        </a>
        <a href="https://youtube.com/@helproot" target="_blank" class="social-icon yt">
          <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_%282017%29.svg" alt="YouTube" style="width: 32px; height: 32px;">
          <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
        </a>
      </div>
    </div>
  </div>

 

  <div id="settings" class="card hidden">
    <h3>‚öôÔ∏è User Settings</h3>
    
    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(109,124,255,0.2);">
      <p style="margin-bottom: 10px; color: #6dff9a; font-weight: bold;">üñºÔ∏èProfile Photo URLüñºÔ∏è</p>
      <input id="photoUrlInput" placeholder="Paste Image URL (PNG/JPG)">
      <button class="action" onclick="updateProfilePhoto()" style="width: 100%;">Update Photo</button>
    </div>

<div style="background: rgba(26, 31, 60, 0.8); border-radius: 15px; padding: 15px; margin-top: 15px; border: 1px solid rgba(109, 124, 255, 0.2);">
  <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #ffeb3b; display: flex; align-items: center; gap: 6px; justify-content: center;">
    üîê Update Security
  </h3>

  <div style="display: flex; flex-direction: column; gap: 8px;">
    <input type="password" id="currPass" placeholder="Current Password" 
      style="width: 100%; padding: 10px; border-radius: 10px; background: #0d1127; border: 1px solid #303651; color: #fff; font-size: 13px; outline: none;">

    <input type="password" id="newPass" placeholder="New Password" 
      style="width: 100%; padding: 10px; border-radius: 10px; background: #0d1127; border: 1px solid #303651; color: #fff; font-size: 13px; outline: none;">

    <input type="password" id="reNewPass" placeholder="Retype New Password" 
      style="width: 100%; padding: 10px; border-radius: 10px; background: #0d1127; border: 1px solid #303651; color: #fff; font-size: 13px; outline: none;">

    <button onclick="updateUserPassword()" style="
      background: linear-gradient(90deg, #6d7cff, #8e99ff);
      color: #fff; border: none; padding: 12px; border-radius: 10px;
      font-weight: 700; cursor: pointer; margin-top: 5px;
      font-size: 13px; letter-spacing: 0.5px;
    ">
      SAVE NEW PASSWORD
    </button>
  </div>
</div>



    <button class="danger" onclick="logout()" style="width: 100%; border-radius: 12px;">üö™Logout Accountüö™</button>
  </div>


    <!-- PRODUCTS -->
    <div id="products" class="card hidden">
      <h3>üõíAvailable Xaiomi Accountsüõí</h3>
      <div id="productList" class="list">Loading products...</div>
    </div>

    <!-- MY KEYS -->
    <div id="mykeys" class="card hidden">
      <h3>üîëMy Purchaseüîë</h3>
      <div id="myKeyList">Loading keys...</div>
    </div>

    <!-- BROADCAST -->
    <div id="broadcast" class="card hidden">
      <h3>üì¢Broadcast Offer</h3>
      <p style="color:#6dff9a; margin-bottom:20px;">Send popup notification to ALL users!</p>
      <div class="broadcast-section">
        <input id="broadcastTitleInput" placeholder="Offer Title (e.g. 50% OFF SALE)">
        <textarea id="broadcastMessageInput" placeholder="Offer message... Make it exciting! üéâ"></textarea>
        <button class="action" onclick="sendBroadcast()">üöÄSend to All Users</button>
      </div>
    </div>

    <!-- VERIFY TRANSACTIONS -->
    <div id="verifyTransactions" class="card hidden">
      <h3>‚úÖPending Payments <span class="pending" id="pendingCount">0</span></h3>
      <div id="transactionList" class="list">Loading pending transactions...</div>
    </div>

    <!-- MANUAL ACCESS -->
    <div id="manualAccess" class="card hidden">
      <h3>üéÅManual Product Access</h3>
      <div class="manual-access-section">
        <input id="manualUserEmail" type="email" placeholder="User Email">
        <input id="manualProductId" placeholder="Product ID (from Manage Products)">
        <button class="action" onclick="giveManualAccess()">üéÅGrant Access</button>
      </div>
    </div>

    <!-- ADD PRODUCT -->
    <div id="addProduct" class="card hidden">
      <h3>‚ûï Add New Product</h3>
      <input id="productName" placeholder="Product Name">
      <input id="productAccessId" placeholder="Access ID">
      <input id="productKey" placeholder="Access Key/Password">
      <input id="productPrice" type="number" placeholder="Price (‚Çπ)">
      <button class="action" onclick="addProduct()">Add Product</button>
    </div>

    <!-- MANAGE USERS -->
    <div id="manageUsers" class="card hidden">
      <h3>üë•Manage Users <span class="ok" id="usersCount">0</span></h3>
      <div id="userManagementList" class="list">Loading users...</div>
    </div>

    <!-- MANAGE PRODUCTS -->
    <div id="manageProducts" class="card hidden">
      <h3>üîßManage Products <span class="ok" id="productsCount">0</span></h3>
      <div id="productManagementList" class="list">Loading products...</div>
    </div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="lock">
  <div class="card">
    <h3>Xaiomi BTunlock Accounts Store</h3>
    
    <div class="live-status">
  <span class="live-dot"></span> STOCK ONLINE - FETCHING LIVE DATA..
</div>

    <div id="loginStats" style="display: flex; justify-content: space-around; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; border: 1px solid rgba(109,124,255,0.1);">
  <div style="text-align: center;">
    <small style="display: block; font-size: 10px; color: #8a8fc4; text-transform: uppercase;">Stock</small>
    <b id="loginStock" style="color: #6dff9a; font-size: 18px;">--</b>
    <small style="display: block; font-size: 9px; opacity: 0.7;">Available</small>
  </div>
  <div style="width: 1px; background: rgba(255,255,255,0.1);"></div>
  <div style="text-align: center;">
    <small style="display: block; font-size: 10px; color: #8a8fc4; text-transform: uppercase;">Sold</small>
    <b id="loginSold" style="color: #ff6b35; font-size: 18px;">--</b>
    <small style="display: block; font-size: 9px; opacity: 0.7;">Out Today</small>
  </div>
</div>

    <div style="display:flex;gap:12px;margin-bottom:10px">
      <button class="action" style="flex:1" onclick="showLoginType('user')">Userüë§Login</button>
      <button class="action" style="flex:1;background:#ff6b35" onclick="showLoginType('admin')">AdminüëëLogin</button>
    </div>

    <div id="userLogin">
      <input id="userEmail" type="email" placeholder="Email">
      <input id="userPassword" type="password" placeholder="Password">
      <p style="margin:5px 0;font-size:20px;text-align:center">
      <button class="action" onclick="userLogin()">Login</button>
      <p style="margin:5px 0;font-size:15px;text-align:center">
        <a href="#" onclick="showUserSignup()" style="color:#6dff9a">Register</a> | 
        <a href="#" onclick="showUserForgot()" style="color:#6dff9a">Forget Password</a>
      </p>
    </div>

    <div id="adminLogin" class="hidden">
      <input id="adminEmail" type="email" value="@gmail.com" placeholder="Admin Email">
      <input id="adminPassword" type="password" value="@danger9787" placeholder="Admin Password">
      <p style="margin:5px 0;font-size:20px;text-align:center">
      <button class="action" onclick="adminLogin()">Admin Login</button>
    </div>

    <div id="userSignup" class="hidden">
      <input id="signupEmail" type="email" placeholder="Email">
      <input id="signupPassword" type="password" placeholder="Password">
      <p style="margin:5px 0;font-size:20px;text-align:center">
      <button class="action" onclick="userSignup()">Create Account</button>
    </div>

    <div id="userForgot" class="hidden">
      <input id="forgotEmail" type="email" placeholder="Email">
      <button class="action" onclick="forgotPassword()">Send Reset Link</button>
    </div>

    <p id="msg" class="bad" style="margin-top:15px"></p>
  </div>
</div>

<div id="notify"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCDCijRwIxpHJK0gYmElkocvu8tNKFykpc",
  authDomain: "generalstore-b6e17.firebaseapp.com",
  databaseURL: "https://generalstore-b6e17-default-rtdb.firebaseio.com",
  projectId: "generalstore-b6e17",
  storageBucket: "generalstore-b6e17.firebasestorage.app",
  messagingSenderId: "239645257410",
  appId: "1:239645257410:web:43825aac8e30d15d4f955b",
  measurementId: "G-9YQ7BK5TYT"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null, userRole = 'user', userProducts = [], pendingTransactions = [], allProducts = [];
let editingProductId = null, currentQRProduct = null;

// üî• FIXED BROADCAST - NOW WORKS PERFECTLY
async function sendBroadcast() {
  if (userRole !== 'admin') return notify('‚ùå Admin only!', 'error');

  const title = document.getElementById('broadcastTitleInput').value.trim();
  const message = document.getElementById('broadcastMessageInput').value.trim();

  if (!title || !message) return notify('‚ùå Title aur Message dono bhariye!', 'error');

  try {
    // Ye line database mein "latest_msg" ko naye data se badal degi
    await db.collection('broadcasts').doc("latest_msg").set({
      title: title,
      message: message,
      sentAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: false }); // merge: false matlab purana data poori tarah khatam
    
    notify('‚úÖ Naya message save ho gaya!', 'success');
    
    // Naya message turant dikhane ke liye
    showBroadcast(title, message);
    
    // Inputs saaf karne ke liye
    document.getElementById('broadcastTitleInput').value = '';
    document.getElementById('broadcastMessageInput').value = '';
  } catch (error) {
    console.error("Broadcast error:", error);
    notify('‚ùå Update fail: ' + error.message, 'error');
  }
}


// üî• FIXED CHECK BROADCASTS
// üî• UPDATED: FIXED AUTO-LOAD BROADCAST
async function checkBroadcasts() {
  try {
    // Hum hamesha "latest_msg" wala document hi uthayenge
    const doc = await db.collection('broadcasts').doc("latest_msg").get();
    
    if (doc.exists) {
      const data = doc.data();
      document.getElementById('broadcastTitle').textContent = data.title;
      document.getElementById('broadcastMessage').textContent = data.message;
      document.getElementById('broadcastPopup').style.display = 'block';
      document.getElementById('broadcastPopup').classList.add('show');
    }
  } catch (err) {
    console.log('No saved broadcast');
  }
}




// üî• USERS CAN SUBMIT TX ID - NO PERMISSION ERRORS
async function submitTransaction() {
  const txId = document.getElementById('transactionId').value.trim();
  if (!txId) { notify('‚ùå Enter Transaction ID!', 'error'); return; }
  if (!currentQRProduct) { notify('‚ùå Select a product first!', 'error'); return; }
  try {
    await db.collection('pendingTransactions').add({
      userId: currentUser.uid,
      userEmail: currentUser.email,
      transactionId: txId,
      productId: currentQRProduct,
      status: 'pending',
      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    notify('‚úÖ TX Submitted! Checking status...', 'success');
    closeQRModal();
    showSection('mykeys'); // <-- Ye line user ko status page par le jayegi
  } catch (error) {
    notify(`‚ùå Error: ${error.message}`, 'error');
  }
}


// üî• FIXED LOAD PENDING TRANSACTIONS
// üî• NO INDEX NEEDED - PERFECTLY WORKS!
async function verifyTransaction(txId, userId, productId) {
  if (!confirm('Verify this payment and grant access?')) return;
  
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    const batch = db.batch();
    
    // ‚úÖ AAJ KI DATE (DD/MM/YYYY) - Ye user side pe dikhegi
    const todayStr = new Date().toLocaleDateString('en-GB');

    if (!userDoc.exists) {
      const txDoc = await db.collection('pendingTransactions').doc(txId).get();
      const txData = txDoc.data();
      batch.set(db.collection('users').doc(userId), {
        email: txData.userEmail || "user@store.com",
        role: 'user',
        purchasedProducts: [productId], 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      batch.update(db.collection('users').doc(userId), { 
        purchasedProducts: firebase.firestore.FieldValue.arrayUnion(productId) 
      });
    }

    batch.update(db.collection('pendingTransactions').doc(txId), { 
      status: 'verified', 
      verifiedAt: firebase.firestore.FieldValue.serverTimestamp() 
    });
    
    // üî• FIX: soldDate (Text) aur soldAt (Timestamp) dono save kar rahe hain
    batch.update(db.collection('products').doc(productId), { 
      isSoldOut: true,
      soldDate: todayStr, // Isse 'Recently' ki problem solve hogi
      soldAt: firebase.firestore.FieldValue.serverTimestamp(),
      soldTo: userId
    });
    
    await batch.commit();

    const sound = document.getElementById("successPing");
    if (sound) { sound.currentTime = 0; sound.play().catch(e => {}); }

    notify('‚úÖ Payment Verified & Date Saved!', 'success');
    loadPendingTransactions();

  } catch (err) {
    notify('‚ùå Error: ' + err.message, 'error');
  }
}

// üî• FIXED VERIFY TRANSACTION WITH SOLD OUT FEATURE
// üî• SMART VERIFY: User delete hone par bhi kaam karega

async function verifyTransaction(txId, userId, productId) {
  if (!confirm('Verify this payment and grant access?')) return;
  
  try {
    // 1. Pehle check karein ki kya user Firestore mein maujood hai?
    const userDoc = await db.collection('users').doc(userId).get();
    const batch = db.batch();

    if (!userDoc.exists) {
      console.log("User record missing, recreating during verification...");
      const txDoc = await db.collection('pendingTransactions').doc(txId).get();
      const txData = txDoc.data();
      
      batch.set(db.collection('users').doc(userId), {
        email: txData.userEmail || "recovered_user@store.com",
        role: 'user',
        purchasedProducts: [productId], 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      batch.update(db.collection('users').doc(userId), { 
        purchasedProducts: firebase.firestore.FieldValue.arrayUnion(productId) 
      });
    }

    // 2. Transaction status update karein
    batch.update(db.collection('pendingTransactions').doc(txId), { 
      status: 'verified', 
      verifiedAt: firebase.firestore.FieldValue.serverTimestamp() 
    });
    
    // 3. Product ko sold out mark karein
    batch.update(db.collection('products').doc(productId), { 
      isSoldOut: true,
      soldAt: firebase.firestore.FieldValue.serverTimestamp(),
      soldTo: userId
    });
    
    // Batch commit (Database update)
    await batch.commit();

    // üî• NAYA: SOUND LOGIC üî•
    const sound = document.getElementById("successPing");
    if (sound) {
      sound.currentTime = 0; // Har baar shuru se bajne ke liye
      sound.play().catch(e => console.log("Sound error:", e));
    }

    notify('‚úÖ Approved! User data recovered and verified.', 'success');
    loadPendingTransactions();

  } catch (err) {
    console.error("Verification error:", err);
    notify('‚ùå Verification failed: ' + err.message, 'error');
  }
}



async function rejectTransaction(txId) {
  if (!confirm('Reject this transaction?')) return;
  
  try {
    await db.collection('pendingTransactions').doc(txId).update({
      status: 'rejected',
      rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    notify('‚ùåTransaction rejected!', 'success');
    loadPendingTransactions();
  } catch (err) {
    notify('‚ùå Reject failed!', 'error');
  }
}

// üî• FIXED QR MODAL WITH PRODUCT SELECTION
function showQRModal(productId = null) {
  currentQRProduct = productId;
  document.getElementById('qrModal').classList.add('show');
  document.getElementById('transactionId').value = '';
  
  const product = allProducts.find(p => p.id === productId);
  const amount = product ? product.price : 'XXX';
  
  setTimeout(() => {
    new QRCode(document.getElementById('qrCode'), {
      text: `Pay ‚Çπ${amount} to UPI: yourupi@paytm
Product: ${product?.name || 'Selected'}
TX ID: Submit after payment`,
      width: 200,
      height: 200,
      colorDark: "#000000",
      colorLight: "#ffffff"
    });
  }, 100);
}

function closeQRModal() {
  document.getElementById('qrModal').classList.remove('show');
  currentQRProduct = null;
}

function copyToClipboard(text, button) {
  navigator.clipboard.writeText(text).then(() => {
    const originalText = button.textContent;
    button.textContent = '‚úÖ Copied!';
    button.classList.add('copy-success');
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('copy-success');
    }, 2000);
    notify('Copied to clipboard!', 'success');
  }).catch(() => {
    notify('Copy failed!', 'error');
  });
}

// üî• FIXED PRODUCTS LIST WITH SOLD OUT CHECK
// --- NEW SORTING LOGIC FOR PRODUCTS ---
async function renderProductsList() {
  try {
    const snapshot = await db.collection('products').get();
    allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    if (allProducts.length === 0) {
      document.getElementById('productList').innerHTML = '<p style="text-align:center; opacity:0.5;">No products available</p>';
      return;
    }

    // 1. Smart Sorting: Available upar, Sold niche
    allProducts.sort((a, b) => {
      if (a.isSoldOut !== b.isSoldOut) return a.isSoldOut ? 1 : -1;
      return (b.submittedAt?.toMillis() || 0) - (a.submittedAt?.toMillis() || 0);
    });

    let html = '';
    allProducts.forEach(p => {
      const isPurchased = userProducts.includes(p.id);
      const isSoldOut = p.isSoldOut || false;
      
      // ‚úÖ FIX: Listed Date (Undefined handle karne ke liye)
      let listedDate = "Recently";
      if (p.submittedAt && p.submittedAt.toDate) {
          listedDate = new Date(p.submittedAt.toDate()).toLocaleDateString('en-GB');
      }
      
      if (isSoldOut) {
        // ‚úÖ FIX: Sold Date (Agar string na mile toh timestamp check karega)
        let displaySoldDate = "Recently";
        if (p.soldDate) {
            displaySoldDate = p.soldDate; 
        } else if (p.soldAt && p.soldAt.toDate) {
            displaySoldDate = new Date(p.soldAt.toDate()).toLocaleDateString('en-GB');
        }

        // --- SOLD OUT LOOK: Purana simple design ---
        html += `
          <div class="item" style="opacity: 0.5; border-left: 4px solid #ff4444; margin-bottom: 12px; background: rgba(255,255,255,0.02); padding: 10px 15px; border-radius: 12px;">
            <div style="display:flex; justify-content:space-between; align-items: center;">
               <b style="color: #bbb;">${p.name}</b>
               <small style="color:#ff4444; font-weight:bold; letter-spacing: 1px;">SOLD OUT</small>
            </div>
            <small style="color: #777;">Price: ‚Çπ${p.price} | üìÖ Sold on: ${displaySoldDate}</small>
          </div>`;

      } else if (isPurchased) {
        // --- PURCHASED LOOK ---
        html += `
          <div class="item" style="border-left: 4px solid #6dff9a; background: rgba(109,255,154,0.05); margin-bottom: 12px; border-radius: 12px;">
            <b style="color: #6dff9a;">${p.name}</b> <small style="color: #6dff9a; opacity: 0.8;">(Purchased ‚úÖ)</small><br>
            <button class="action" onclick="showSection('mykeys')" style="padding:6px 12px; font-size:11px; margin-top:8px; border-radius: 8px;">View My Key</button>
          </div>`;

      } else {
        // --- AVAILABLE LOOK: Naya premium design ---
        html += `
          <div style="
            background: linear-gradient(145deg, #232a5e, #15193a);
            border: 1px solid rgba(109, 124, 255, 0.5);
            border-radius: 22px;
            padding: 18px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
          ">
            <div style="position:absolute; top:-10px; right:-10px; width:60px; height:60px; background:rgba(109,124,255,0.15); filter:blur(20px); border-radius:50%;"></div>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
              <div>
                <h3 style="margin: 0; font-size: 17px; color: #fff; font-weight: 700;">${p.name}</h3>
                <div style="margin-top: 4px;">
                  <span style="font-size: 9px; color: #6dff9a; background: rgba(109,255,154,0.1); padding: 2px 8px; border-radius: 10px; border: 1px solid rgba(109,255,154,0.2); font-weight: bold;">‚ö° HIGH QUALITY</span>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="color: #6dff9a; font-size: 22px; font-weight: 900;">‚Çπ${p.price}</div>
                <div style="font-size: 10px; color: #a5b1ff; opacity: 0.6;">Listed: ${listedDate}</div>
              </div>
            </div>
            <button onclick="openQRModal(${p.price}, '${p.id}')" style="
              width: 100%; padding: 12px; border-radius: 14px; border: none; 
              background: linear-gradient(90deg, #6d7cff, #8e99ff); color: #fff; 
              font-weight: 800; font-size: 14px; cursor: pointer;
              box-shadow: 0 5px 15px rgba(109,124,255,0.3);
            ">
              üí≥ BUY THIS ACCOUNT
            </button>
          </div>
        `;
      }
    });
    
    document.getElementById('productList').innerHTML = html;
  } catch (err) {
    console.error("Render Error:", err);
  }
}


// üî• FIXED MY KEYS
async function renderMyKeys() {
  try {
    const keyList = document.getElementById('myKeyList');
    keyList.innerHTML = '<div class="item" style="text-align:center;">‚åõLoading your history...</div>';
    
    // 1. User ki saari transaction history fetch karein (Pending, Rejected, Verified)
    const txSnapshot = await db.collection('pendingTransactions')
      .where('userId', '==', currentUser.uid)
      .get();

    // 2. Products data fetch karein credentials dikhane ke liye
    const productsSnapshot = await db.collection('products').get();
    const allProducts = productsSnapshot.docs.reduce((acc, doc) => {
      acc[doc.id] = { id: doc.id, ...doc.data() };
      return acc;
    }, {});

    if (txSnapshot.empty) {
      keyList.innerHTML = '<div class="item" style="text-align:center;"><p class="bad">No purchase history found.</p></div>';
      return;
    }

    // 3. Transactions ko Date ke hisaab se Sort karein (Latest First)
    const sortedTransactions = txSnapshot.docs.sort((a, b) => 
      (b.data().submittedAt?.toMillis() || 0) - (a.data().submittedAt?.toMillis() || 0)
    );

    let html = '<h4 style="color:#ffeb3b; margin: 10px 0 15px 0;">üìÖOrder History (Date Wise)</h4>';

    sortedTransactions.forEach(doc => {
      const tx = doc.data();
      const subDate = tx.submittedAt ? new Date(tx.submittedAt.toDate()).toLocaleString('en-GB') : 'Processing...';
      const productId = tx.productId;
      const productInfo = allProducts[productId];

      // Status ke hisaab se UI design set karein
      let cardStyle = "border-left: 4px solid #ffeb3b; background: rgba(255,235,59,0.05);";
      let statusLabel = "Pending ‚è≥";
      let statusColor = "#ffeb3b";

      if (tx.status === 'rejected') {
        cardStyle = "border-left: 4px solid #ff4444; background: rgba(255,68,68,0.05);";
        statusLabel = "Rejected‚ùå";
        statusColor = "#ff4444";
      } else if (tx.status === 'verified') {
        cardStyle = "border-left: 4px solid #6dff9a; background: rgba(109,255,154,0.05);";
        statusLabel = "Verified & Added ‚úÖ";
        statusColor = "#6dff9a";
      }

      // Base Transaction Card
      html += `
        <div class="item" style="${cardStyle} margin-bottom:15px; padding:15px;">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
            <b style="font-size:14px; color:#fff;">ID: ${productId}</b>
            <span style="font-size:12px; font-weight:bold; color:${statusColor};">${statusLabel}</span>
          </div>
          <div style="font-size:12px; opacity:0.8; line-height:1.6;">
            üìÖ <b>Submitted:</b> ${subDate}<br>
            üí≥ <b>UTR:</b> ${tx.transactionId}
          </div>
      `;

      // Agar Verified hai toh credentials (ID/Key) niche hi dikhayenge
      if (tx.status === 'verified' && productInfo) {
        html += `
          <div class="product-creds" style="margin-top:12px; background:rgba(0,0,0,0.2); border:1px solid #6dff9a;">
            <div style="margin-bottom:8px;">
              <b style="color:#6dff9a;">üÜîLogin ID:</b> <span style="word-break:break-all;">${productInfo.loginId}</span>
              <button class="copy-btn" style="width:100%; margin-top:5px; padding:5px;" onclick="copyToClipboard('${productInfo.loginId}', this)">Copy ID</button>
            </div>
            ${productInfo.key ? `
            <div>
              <b style="color:#6dff9a;">üîëPassword:</b> <span>${productInfo.key}</span>
              <button class="copy-btn" style="width:100%; margin-top:5px; padding:5px;" onclick="copyToClipboard('${productInfo.key}', this)">Copy Key</button>
            </div>` : ''}
          </div>
        `;
      }
      
      html += `</div>`; // Closing transaction card
    });

    keyList.innerHTML = html;
  } catch (err) {
    console.error(err);
    document.getElementById('myKeyList').innerHTML = '<div class="item"><p class="bad">Error loading history. Please refresh.</p></div>';
  }
}



// üî• FIXED LOAD USER DATA
// 1. Photo Update Function
// üî• FIXED: Photo Update & Refresh
async function updateProfilePhoto() {
  const url = document.getElementById('photoUrlInput').value.trim();
  if(!url) return notify('‚ùå Please paste an Image URL!', 'error');
  
  try {
    await db.collection('users').doc(currentUser.uid).update({ 
      profilePhoto: url 
    });
    notify('‚úÖProfile Photo Updated!', 'success');
    document.getElementById('photoUrlInput').value = '';
    
    // Turant UI update karne ke liye dobara load karein
    await loadUserData(); 
  } catch(err) { 
    notify('‚ùå Update failed!', 'error'); 
  }
}

// üî• FIXED: Sidebar Photo Rendering
async function loadUserData() {
  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    let photoUrl = "";
    
    if(userDoc.exists) {
      const data = userDoc.data();
      userRole = data.role || 'user';
      userProducts = data.purchasedProducts || [];
      photoUrl = data.profilePhoto || ""; 
    }
    
    const userEmail = currentUser.email;
    const sideAvatar = document.getElementById('sideAvatar');

    // --- PHOTO DISPLAY LOGIC ---
    if(photoUrl && photoUrl !== "") {
      // Agar database mein photo link hai toh <img> tag dalo
      sideAvatar.innerHTML = `<img src="${photoUrl}" onerror="this.src='https://ui-avatars.com/api/?name=${userEmail}&background=6d7cff&color=fff'">`;
    } else {
      // Agar photo nahi hai toh Email ka pehla letter
      sideAvatar.innerHTML = `<span style="font-size:20px; font-weight:bold; color:white;">${userEmail.charAt(0).toUpperCase()}</span>`;
    }

    // Sidebar Name & Role
    let namePart = userEmail.split('@')[0].toUpperCase();
    if(namePart.length > 10) namePart = namePart.substring(0, 8) + "..";
    document.getElementById('sideName').textContent = namePart;
    document.getElementById('sideRole').textContent = userRole === 'admin' ? 'üëëAdministrator' : 'Verified User‚úÖ';

    // Dashboard Stats
    document.getElementById('userInfo').textContent = userEmail;
    document.getElementById('roleBadge').textContent = userRole.toUpperCase();

    const prodSnapshot = await db.collection('products').get();
    const availableOnly = prodSnapshot.docs.filter(p => !p.data().isSoldOut).length;
    
    document.getElementById('totalProducts').textContent = availableOnly; 
    document.getElementById('userKeys').textContent = userProducts.length;

    if(userRole === 'admin') {
      document.getElementById('adminSection').classList.remove('hidden');
      document.getElementById('userSection').classList.add('hidden');
    }
  } catch(err) { 
    console.error("Profile Load Error:", err); 
  }
}






// üî• ALL OTHER FUNCTIONS (UNCHANGED BUT WORKING)
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menuBtn');
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    openSidebar();
  }
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('show'); // Overlay dikhao
  document.getElementById('menuBtn').classList.add('hidden');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show'); // Overlay chupao
  document.getElementById('menuBtn').classList.remove('hidden');
}


function showSection(id, fromNav = false) {
  closeSidebar();
  document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  
  if (fromNav && event?.target) {
    document.querySelectorAll('.nav-active').forEach(btn => btn.classList.remove('nav-active'));
    event.target.classList.add('nav-active');
  }
  
  if(id === 'products') renderProductsList();
  if(id === 'mykeys') renderMyKeys();
  if(id === 'manageUsers') loadUserManagement();
  if(id === 'manageProducts') loadProductManagement();
  if(id === 'verifyTransactions') loadPendingTransactions();
}

function notify(msg, type='success'){
  const n = document.getElementById("notify");
  n.textContent = msg;
  n.style.background = type==='success' ? '#6dff9a' : '#ff7b7b';
  n.style.display = "block";
  setTimeout(()=>n.style.display = "none", 4000);
}

function showBroadcast(title, message) {
  document.getElementById('broadcastTitle').textContent = title;
  document.getElementById('broadcastMessage').textContent = message;
  document.getElementById('broadcastPopup').classList.add('show');
}

function closeBroadcast() {
  document.getElementById('broadcastPopup').classList.remove('show');
}








function showLoginType(type) {
  ['userLogin','adminLogin','userSignup','userForgot'].forEach(id => {
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(type === 'user' ? 'userLogin' : 'adminLogin').classList.remove('hidden');
}

async function userLogin() {
  try {
    await auth.signInWithEmailAndPassword(
      document.getElementById('userEmail').value, 
      document.getElementById('userPassword').value
    );
  } catch(err) {
    document.getElementById('msg').textContent = err.message;
    document.getElementById('msg').className = 'bad';
  }
}

async function adminLogin() {
  try {
    await auth.signInWithEmailAndPassword(
      document.getElementById('adminEmail').value, 
      document.getElementById('adminPassword').value
    );
  } catch(err) {
    document.getElementById('msg').textContent = 'Admin login failed!';
    document.getElementById('msg').className = 'bad';
  }
}

async function userSignup() {
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(
      document.getElementById('signupEmail').value, 
      document.getElementById('signupPassword').value
    );
    await db.collection('users').doc(userCredential.user.uid).set({
      email: document.getElementById('signupEmail').value,
      role: 'user',
      purchasedProducts: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    notify('Account created successfully!');
  } catch(err) {
    document.getElementById('msg').textContent = err.message;
    document.getElementById('msg').className = 'bad';
  }
}

async function forgotPassword() {
  try {
    await auth.sendPasswordResetEmail(document.getElementById('forgotEmail').value);
    notify('Reset email sent!');
  } catch(err) {
    document.getElementById('msg').textContent = err.message;
    document.getElementById('msg').className = 'bad';
  }
}
async function updateUserPassword() {
  const currPass = document.getElementById('currPass').value;
  const newPass = document.getElementById('newPass').value;
  const reNewPass = document.getElementById('reNewPass').value;
  const user = firebase.auth().currentUser;

  if (!currPass || !newPass || !reNewPass) return notify('‚ùå Fill all fields!', 'error');
  if (newPass !== reNewPass) return notify('‚ùå Passwords do not match!', 'error');
  if (newPass.length < 6) return notify('‚ùå Min 6 characters required!', 'error');

  try {
    // Re-verify the user
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currPass);
    await user.reauthenticateWithCredential(credential);

    // Update to new password
    await user.updatePassword(newPass);

    notify('‚úÖ Password Changed!', 'success');
    
    // Clear the form
    document.getElementById('currPass').value = '';
    document.getElementById('newPass').value = '';
    document.getElementById('reNewPass').value = '';

  } catch (error) {
    if (error.code === 'auth/wrong-password') {
      notify('‚ùå Current password wrong!', 'error');
    } else {
      notify('‚ùå Failed: ' + error.message, 'error');
    }
  }
}


// 1. Logout Function
function logout() {
  auth.signOut().then(() => {
    location.reload(); 
  }).catch((err) => {
    console.error("Logout Error:", err);
  });
  closeSidebar();
}

// üî• MODIFIED: Auto-recreate user if deleted from Firestore
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    
    // Check if user exists in Firestore
    const userDoc = await db.collection('users').doc(user.uid).get();
    
    if (!userDoc.exists) {
      // Agar user Firestore me nahi hai (aapne delete kiya tha), toh use dobara "user" role ke sath create karo
      console.log("Re-creating missing user record...");
      await db.collection('users').doc(user.uid).set({
        email: user.email,
        role: 'user',
        purchasedProducts: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    await loadUserData(); // Dashboard data load karein
    unlockApp();          // App open karein
    checkBroadcasts();    
  } else {
    showLockScreen();     
  }
});


// 3. App Unlock logic
function unlockApp() {
  document.body.classList.remove('login-mode');
  document.getElementById('lock').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  showSection('dashboard');
}

// 4. Lock Screen logic
function showLockScreen() {
  document.body.classList.add('login-mode');
  document.getElementById('lock').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  showLoginType('user');
}

// 5. Broadcast Popup Band karne ka function
function closeBroadcast() {
  const popup = document.getElementById('broadcastPopup');
  popup.style.display = 'none';
  popup.classList.remove('show');
}

// 6. User Signup/Forgot Password toggles
function showUserSignup() {
  document.getElementById('userSignup').classList.remove('hidden');
  document.getElementById('userLogin').classList.add('hidden');
}

function showUserForgot() {
  document.getElementById('userForgot').classList.remove('hidden');
  document.getElementById('userLogin').classList.add('hidden');
}

function handleUPIPayment() {
    const upiId = "igrishu2024@okaxis"; 
    const storeName = "Xiaomi Store";

    // Debugging ke liye alert (Check karne ke liye ki function chal raha hai)
    console.log("Paying Amount:", currentProductPrice);

    if (!currentProductPrice || currentProductPrice <= 0) {
        alert("‚ùåError: Price zero hai! Please product ko phir se select karein.");
        return;
    }

    // UPI Link
    const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(storeName)}&am=${currentProductPrice}&cu=INR`;

    if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
        // Mobile par app kholne ki koshish karega
        window.location.href = upiLink;
        
        setTimeout(() => {
    // Alert ki jagah Toast dikhayega
    var x = document.getElementById("toast");
    x.className = "show";
    
    // 5 second baad toast apne aap gayab ho jayega
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 4000);
}, 1000);

    } else {
        alert("Desktop par UPI Apps nahi khulte. Please phone se QR scan karein.");
    }
}


// --- MODAL FUNCTIONS (FIXED) ---

// Ye function 'Buy Now' click karne par modal kholega
function openQRModal(price, productId) {
    currentProductPrice = parseFloat(price);
    currentQRProduct = productId;
    
    const modal = document.getElementById('qrModal');
    if (modal) {
        modal.style.display = 'flex';
        // Input box ko khali kar dega naye transaction ke liye
        document.getElementById('transactionId').value = '';
    }
}

// Ye 'X' button click karne par modal band karega
function closeQRModal() {
    const modal = document.getElementById('qrModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Ye Submit button ke liye hai (Firebase mein data jayega)
async function submitTransaction() {
    const txInput = document.getElementById('transactionId');
    const txId = txInput ? txInput.value.trim() : "";

    if (!currentQRProduct) {
        alert("‚ùå Error: First Select Xaiomi Account ! then click Buy now");
        return;
    }
    if (!txId) {
        alert("‚ùå UTR / Transaction ID daalna zaroori hai.");
        return;
    }

    try {
        // Firebase Firestore mein entry
        await db.collection('pendingTransactions').add({
            userId: auth.currentUser.uid,
            userEmail: auth.currentUser.email,
            transactionId: txId,
            productId: currentQRProduct,
            amount: currentProductPrice,
            status: 'pending',
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("‚úÖ Success! Admin 5m mein aprove kar dega");
        closeQRModal(); 

    } catch (error) {
        alert("‚ùå Error: " + error.message);
    }
}



// --- YEH LOGIN PAGE STATS KA CODE HAI ---

async function fetchPublicStats() {
  try {
    // Bina login kiye products ka count lene ke liye
    const snapshot = await db.collection('products').get();
    let available = 0;
    let sold = 0;

    snapshot.forEach(doc => {
      if (doc.data().isSoldOut === true) {
        sold++;
      } else {
        available++;
      }
    });

    // Dashboard IDs ke saath confusion na ho isliye checks lagaye hain
    const stockEl = document.getElementById('loginStock');
    const soldEl = document.getElementById('loginSold');
    
    if(stockEl) stockEl.textContent = available;
    if(soldEl) soldEl.textContent = sold;
    
  } catch (err) {
    console.error("Public Stats Error:", err);
  }
}

// Page load hote hi ise turant chalana hai
fetchPublicStats();

// Har 30 second mein automatic update (Optional)
setInterval(fetchPublicStats, 30000); 

// Admin functions
async function giveManualAccess() {
  if (userRole !== 'admin') {
    notify('‚ùåAdmin only!', 'error');
    return;
  }
  const userEmail = document.getElementById('manualUserEmail').value.trim();
  const productId = document.getElementById('manualProductId').value.trim();
  if (!userEmail || !productId) {
    notify('‚ùåEnter both email & product ID!', 'error');
    return;
  }
  try {
    const usersSnapshot = await db.collection('users').where('email', '==', userEmail).get();
    if (usersSnapshot.empty) {
      notify('‚ùåUser not found!', 'error');
      return;
    }
    const userDoc = usersSnapshot.docs[0];
    await db.collection('users').doc(userDoc.id).update({
      purchasedProducts: firebase.firestore.FieldValue.arrayUnion(productId)
    });
    // Mark product as sold out
    await db.collection('products').doc(productId).update({
      isSoldOut: true,
      soldAt: firebase.firestore.FieldValue.serverTimestamp(),
      soldTo: userDoc.id
    });
    notify(`‚úÖ Access granted to ${userEmail}! Product marked SOLD OUT`, 'success');
    document.getElementById('manualUserEmail').value = '';
    document.getElementById('manualProductId').value = '';
    renderProductsList();
  } catch (err) {
    notify('‚ùå Failed to grant access!', 'error');
  }
}

// üî• PERFECTLY FIXED - NO MORE "Error loading users"
async function loadUserManagement() {
  if (userRole !== 'admin') return notify('‚ùåAdmin only!', 'error');
  
  try {
    document.getElementById('userManagementList').innerHTML = 'Loading users...';
    const snapshot = await db.collection('users').get();
    
    // Sort: New users first
    const sortedUsers = snapshot.docs.sort((a, b) => {
      const dateA = a.data().createdAt?.toMillis() || 0;
      const dateB = b.data().createdAt?.toMillis() || 0;
      return dateB - dateA;
    });
    
    let html = '';
    sortedUsers.forEach(doc => {
      const u = doc.data();
      const regDate = u.createdAt ? new Date(u.createdAt.toDate()).toLocaleDateString('en-GB') : 'N/A';
      // Purchase Count nikalne ke liye
      const purchaseCount = u.purchasedProducts ? u.purchasedProducts.length : 0;
      const userRoleColor = u.role === 'admin' ? '#ff6b35' : '#6dff9a';
      
      html += `
        <div class="item" style="
          background: linear-gradient(145deg, #1e244a, #15193a);
          border: 1px solid rgba(255,255,255,0.05);
          border-radius: 16px;
          padding: 12px 15px;
          margin: 10px 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        ">
          <div style="flex: 1; overflow: hidden; margin-right: 10px;">
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
              <b style="font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff;">
                ${u.email}
              </b>
              <span style="color: ${userRoleColor}; font-size: 9px; font-weight: 800; text-transform: uppercase;">
                [${u.role}]
              </span>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 2px;">
              <small style="font-size: 10px; color: #a5b1ff; opacity: 0.8;">üìÖ Registered: ${regDate}</small>
              <div style="display: flex; align-items: center; gap: 4px; margin-top: 2px;">
                <span style="font-size: 10px; background: rgba(109,124,255,0.2); color: #6d7cff; padding: 2px 8px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(109,124,255,0.3);">
                  üõí Purchased: ${purchaseCount}
                </span>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button class="manual-verify" onclick="viewUserHistory('${doc.id}', '${u.email}')" 
              style="width: 38px; height: 38px; min-width: 38px; border-radius: 12px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; background: #ffeb3b; border: none;" title="History">
              üëÅÔ∏è
            </button>
            <button class="danger" onclick="deleteUser('${doc.id}')" 
              style="width: 38px; height: 38px; min-width: 38px; border-radius: 12px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; background: #ff4444; border: none;" title="Delete">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `;
    });
    document.getElementById('userManagementList').innerHTML = html;
    document.getElementById('usersCount').textContent = snapshot.size;
  } catch(err) {
    notify('‚ùåError loading users', 'error');
  }
}



async function viewUserHistory(userId, userEmail) {
  try {
    // User details fetch karein registration date ke liye
    const userDoc = await db.collection('users').doc(userId).get();
    const userData = userDoc.data();
    const registrationDate = userData.createdAt ? 
      new Date(userData.createdAt.toDate()).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' }) : 
      'Unknown';

    const txSnapshot = await db.collection('pendingTransactions')
      .where('userId', '==', userId)
      .get();

    let html = `<h3>üìúHistory for: ${userEmail}</h3>`;
    // Registration Date Header
    html += `
      <div style="background:rgba(109,124,255,0.1); padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid #6d7cff; text-align:center;">
        <span style="color:#6dff9a; font-weight:bold;">üìÖ Joined On:</span> ${registrationDate}
      </div>
    `;
    
    html += `<button class="action" onclick="showSection('manageUsers')" style="margin-bottom:15px; width:100%;">‚¨ÖÔ∏è Back to Users List</button>`;

    if (txSnapshot.empty) {
      html += '<p style="text-align:center; padding:20px; color:#aaa;">No purchase history found for this user.</p>';
    } else {
      const sorted = txSnapshot.docs.sort((a,b) => (b.data().submittedAt?.toMillis() || 0) - (a.data().submittedAt?.toMillis() || 0));
      
      sorted.forEach(doc => {
        const tx = doc.data();
        const date = tx.submittedAt ? new Date(tx.submittedAt.toDate()).toLocaleString() : 'N/A';
        const color = tx.status === 'verified' ? '#6dff9a' : (tx.status === 'rejected' ? '#ff4444' : '#ffeb3b');

        html += `
          <div class="item" style="border-left: 4px solid ${color};">
            <div style="display:flex; justify-content:space-between;">
              <b>ID: ${tx.productId}</b>
              <b style="color:${color}">${tx.status.toUpperCase()}</b>
            </div>
            <small>üìÖ TX Date: ${date} | üí≥ UTR: ${tx.transactionId}</small>
            <div class="row">
              <button class="danger" style="padding:5px; font-size:12px;" onclick="deleteTransaction('${doc.id}', '${userId}', '${userEmail}')">üóëÔ∏è Delete Entry</button>
            </div>
          </div>
        `;
      });
    }

    document.getElementById('userManagementList').innerHTML = html;
  } catch (err) {
    console.error(err);
    notify('‚ùå Error fetching history', 'error');
  }
}


// Function to delete specific history entry
async function deleteTransaction(txId, userId, userEmail) {
  if(!confirm('Are you sure you want to delete this history record?')) return;
  try {
    await db.collection('pendingTransactions').doc(txId).delete();
    notify('‚úÖ History deleted!');
    viewUserHistory(userId, userEmail); // Refresh list
  } catch(err) {
    notify('‚ùå Delete failed', 'error');
  }
}

// üî• UPDATED: Admin can now see WHO bought the product
async function loadProductManagement() {
  try {
    document.getElementById('productManagementList').innerHTML = 'Loading products...';
    
    const [prodSnapshot, userSnapshot] = await Promise.all([
      db.collection('products').get(),
      db.collection('users').get()
    ]);

    const userMap = {};
    userSnapshot.forEach(doc => { userMap[doc.id] = doc.data().email; });

    let products = prodSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    if(products.length === 0) {
      document.getElementById('productManagementList').innerHTML = '<p style="text-align:center; opacity:0.5;">No products found</p>';
      return;
    }

    // üî• SORTING LOGIC: Available upar (Active), Sold niche
    products.sort((a, b) => {
      if (a.isSoldOut !== b.isSoldOut) {
        return a.isSoldOut ? 1 : -1; // false (Active) pehle, true (Sold) baad mein
      }
      // Agar dono same status ke hain toh naya wala upar
      return (b.submittedAt?.toMillis() || 0) - (a.submittedAt?.toMillis() || 0);
    });

    let html = '';
    products.forEach(p => {
      const isSold = p.isSoldOut || false;
      
      // Date Formatting
      let dateStr = "New";
      if (p.submittedAt) {
          const d = p.submittedAt.toDate();
          dateStr = d.toLocaleDateString('en-GB') + " " + d.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', hour12: true});
      }

      const buyerEmail = isSold && p.soldTo ? (userMap[p.soldTo] || "Unknown User") : null;

      // --- PREMIUM SIMPLE DESIGN ---
      html += `
        <div style="
          background: #1a1f3c; 
          border: 1px solid ${isSold ? 'rgba(255, 68, 68, 0.2)' : 'rgba(109, 255, 154, 0.2)'};
          border-radius: 20px;
          padding: 20px;
          margin-bottom: 15px;
          position: relative;
        ">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h3 style="margin: 0; font-size: 16px; color: #fff; letter-spacing: 0.5px;">${p.name}</h3>
              <div style="font-size: 10px; color: #6d7cff; margin-top: 4px; opacity: 0.8;">ID: ${p.id}</div>
            </div>
            <div style="
              background: ${isSold ? 'rgba(255, 68, 68, 0.1)' : 'rgba(109, 255, 154, 0.1)'};
              color: ${isSold ? '#ff4444' : '#6dff9a'};
              padding: 5px 12px;
              border-radius: 20px;
              font-size: 9px;
              font-weight: 800;
              border: 1px solid ${isSold ? 'rgba(255, 68, 68, 0.2)' : 'rgba(109, 255, 154, 0.2)'};
              display: flex; align-items: center; gap: 4px;
            ">
              <span style="font-size: 12px;">‚óè</span> ${isSold ? 'SOLD OUT' : 'ACTIVE'}
            </div>
          </div>

          <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 12px;">
             <span style="color: #bbb;">Price: <b style="color: #6dff9a;">‚Çπ${p.price}</b></span>
             <span style="color: #bbb;">Key: <b style="color: #ffeb3b;">${p.key || '@notset'}</b></span>
          </div>
          <div style="color: #555; font-size: 10px; margin-top: 6px;">üìÖ Added on: ${dateStr}</div>

          ${isSold ? `
            <div style="margin-top: 15px; padding: 12px; background: rgba(255,68,68,0.05); border-radius: 12px; border: 1px dashed rgba(255,68,68,0.3);">
              <div style="color: #ff8a8a; font-size: 9px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px;">üë§ BOUGHT BY</div>
              <div style="color: #fff; font-size: 12px; opacity: 0.9;">${buyerEmail}</div>
            </div>
          ` : ''}

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 18px;">
            <button onclick="editProduct('${p.id}','${p.name}','${p.loginId}','${p.key}',${p.price})" style="
              background: transparent;
              color: #6d7cff;
              border: 1px solid rgba(109, 124, 255, 0.4);
              padding: 10px;
              border-radius: 12px;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
              display: flex; align-items: center; justify-content: center; gap: 6px;
            ">‚úèÔ∏è Edit</button>
            
            <button onclick="deleteProduct('${p.id}')" style="
              background: transparent;
              color: #ff4444;
              border: 1px solid rgba(255, 68, 68, 0.4);
              padding: 10px;
              border-radius: 12px;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
              display: flex; align-items: center; justify-content: center; gap: 6px;
            ">üóëÔ∏è Delete</button>
          </div>
        </div>`;
    });
    
    document.getElementById('productManagementList').innerHTML = html;
    document.getElementById('productsCount').textContent = products.length;
  } catch(err) {
    console.error(err);
    document.getElementById('productManagementList').innerHTML = '<p style="color:#ff4444; text-align:center;">Error loading list</p>';
  }
}




async function addProduct() {
  const name = document.getElementById('productName').value;
  const accessId = document.getElementById('productAccessId').value;
  const key = document.getElementById('productKey').value;
  const price = parseInt(document.getElementById('productPrice').value);

  if (!name || !accessId || !key || !price) {
    return notify('Fill all fields!', 'error');
  }

  try {
    if (editingProductId) {
      // üî• Edit karte waqt bhi timestamp update hoga (Optional)
      await db.collection('products').doc(editingProductId).update({
        name, loginId: accessId, key, price,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp() 
      });
      notify('‚úÖ Product updated!');
      editingProductId = null;
    } else {
      // üî• Naya product add karte waqt server date
      await db.collection('products').add({
        name: name, 
        loginId: accessId, 
        key: key, 
        price: price, 
        isSoldOut: false,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp() 
      });
      notify('‚úÖ Product added!');
    }

    // Inputs Clear karein
    document.getElementById('productName').value = '';
    document.getElementById('productAccessId').value = '';
    document.getElementById('productKey').value = '';
    document.getElementById('productPrice').value = '';

    loadProductManagement(); // Turant list refresh karein
  } catch (err) {
    notify('Error adding product!', 'error');
  }
}


function editProduct(productId, name, accessId, key, price) {
  editingProductId = productId;
  document.getElementById('productName').value = name;
  document.getElementById('productAccessId').value = accessId;
  document.getElementById('productKey').value = key;
  document.getElementById('productPrice').value = price;
  showSection('addProduct');
  notify(`Editing: ${name}`);
}

async function deleteUser(userId) {
  if(!confirm('Delete this user?')) return;
  try {
    await db.collection('users').doc(userId).delete();
    notify('‚úÖ User deleted!');
    loadUserManagement();
  } catch(err) {
    notify('Delete failed!', 'error');
  }
}

async function deleteProduct(productId) {
  if(!confirm('Delete this product?')) return;
  try {
    await db.collection('products').doc(productId).delete();
    notify('‚úÖ Product deleted!');
    loadProductManagement();
    loadUserData();
    renderProductsList();
  } catch(err) {
    notify('Delete failed!', 'error');
  }
}

function editUser(userId) {
  notify('Edit user coming soon!');
}
</script>
</body>
</html>
